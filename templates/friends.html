{% extends "base_dashboard.html" %}

{% block title %}Friends - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
    <div class="friends-page-content">
        <!-- Add Friend Section -->
        <div class="add-friend-card">
            <h3 class="add-friend-title">üëã Add Friend</h3>
            <div class="add-friend-form">
                <input type="email" id="friendEmail" placeholder="Enter friend's email address" class="friend-input">
                <button type="button" id="searchFriendBtn" class="btn-search-friend">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>
        
        <!-- Friend Requests Section -->
        <div class="friend-requests-card">
            <h3 class="requests-title">üì• Friend Requests (<span id="requestCount">0</span>)</h3>
            <div id="friendRequestsList" class="requests-list">
                <div class="empty-state">
                    <p>No pending friend requests</p>
                </div>
            </div>
        </div>

        <!-- My Friends Section -->
        <div class="my-friends-card">
            <h3 class="my-friends-title">üë• My Friends (<span id="friendCount">0</span>)</h3>
            <div id="friendsList" class="friends-list">
                <!-- Friends will be loaded here dynamically -->
                <div class="empty-state">
                    <p>No friends yet. Add friends to see them here!</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üéØ Friends page loaded');
    
    // Load friends list on page load
    loadFriends();
    
    // Handle search friend
    document.getElementById('searchFriendBtn').addEventListener('click', handleSearchFriend);
    
    // Allow Enter key to search
    document.getElementById('friendEmail').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            handleSearchFriend();
        }
    });
});

async function loadFriends() {
    console.log('üì• Loading friends...');
    try {
        console.log('üåê Fetching /api/friends');
        const response = await fetch('/api/friends');
        console.log('üì° Response status:', response.status, response.statusText);
        
        if (!response.ok) {
            console.error('‚ùå Failed to load friends:', response.status);
            const errorText = await response.text();
            console.error('‚ùå Error response:', errorText);
            document.getElementById('friendsList').innerHTML = 
                '<div class="empty-state"><p>‚ö†Ô∏è Please log in to view your friends</p></div>';
            return;
        }
        
        const data = await response.json();
        console.log('üì¶ Friends data:', data);
        
        if (data.success) {
            console.log('‚úÖ Processing friends data:', data.friends);
            console.log('üì• Processing incoming requests:', data.incomingRequests);
            console.log('üì§ Processing outgoing requests:', data.outgoingRequests);
            
            displayFriends(data.friends || []);
            
            // Combine incoming and outgoing requests for display
            const allRequests = [
                ...(data.incomingRequests || []),
                ...(data.outgoingRequests || [])
            ];
            displayFriendRequests(allRequests);
            document.getElementById('friendCount').textContent = (data.friends || []).length;
        } else {
            console.error('‚ùå Error in response:', data);
        }
    } catch (error) {
        console.error('üí• Error loading friends:', error);
    }
}

function displayFriendRequests(requests) {
    console.log('üì• Displaying friend requests:', requests);
    console.log('üìä Request count:', requests?.length);
    console.log('üìù Request type:', typeof requests);
    
    const requestsList = document.getElementById('friendRequestsList');
    const requestCount = document.getElementById('requestCount');
    
    console.log('üîç Found elements:', {
        requestsList: !!requestsList,
        requestCount: !!requestCount
    });
    
    requestCount.textContent = requests.length;
    
    if (requests.length === 0) {
        requestsList.innerHTML = '<div class="empty-state"><p>No pending friend requests</p></div>';
        return;
    }
    
    requestsList.innerHTML = requests.map(request => {
        if (request.type === 'incoming') {
            return `
                <div class="request-card incoming-request">
                    <div class="request-info">
                        <div class="user-icon">üë§</div>
                        <div class="user-details">
                            <h4>${request.displayName} <span class="request-label incoming">wants to be friend</span></h4>
                            <p>${request.email}</p>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="btn-accept" onclick="acceptFriendRequest('${request.uid}', '${request.displayName}')">
                            <i class="fas fa-check"></i>
                            Accept
                        </button>
                        <button class="btn-decline" onclick="declineFriendRequest('${request.uid}')">
                            <i class="fas fa-times"></i>
                            Decline
                        </button>
                    </div>
                </div>
            `;
        } else {
            // Outgoing request
            return `
                <div class="request-card outgoing-request">
                    <div class="request-info">
                        <div class="user-icon">üë§</div>
                        <div class="user-details">
                            <h4>${request.displayName} <span class="request-label outgoing">request sent</span></h4>
                            <p>${request.email}</p>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="btn-cancel" onclick="cancelFriendRequest('${request.uid}')">
                            <i class="fas fa-times"></i>
                            Cancel Request
                        </button>
                    </div>
                </div>
            `;
        }
    }).join('');
}

function displayFriends(friends) {
    const friendsList = document.getElementById('friendsList');
    
    if (friends.length === 0) {
        friendsList.innerHTML = '<div class="empty-state"><p>No friends yet. Add friends to see them here!</p></div>';
        return;
    }
    
    friendsList.innerHTML = friends.map(friend => `
        <div class="friend-card" data-friend-id="${friend.uid}">
            <div class="friend-info">
                <div class="friend-name">
                    ${friend.displayName} ${getStreakBadge(friend.stats?.currentStreak)}
                </div>
                <div class="friend-streak">
                    üî• ${friend.stats?.currentStreak || 0} day current streak
                </div>
                ${getStreakBadges(friend.stats?.currentStreak)}
            </div>
            <button class="btn-remove-friend" onclick="removeFriend('${friend.uid}', '${friend.displayName}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `).join('');
}

function getStreakBadge(streak) {
    if (!streak) return '';
    if (streak >= 30) return 'üèÜ';
    if (streak >= 7) return '‚≠ê';
    return '';
}

function getStreakBadges(streak) {
    if (!streak) return '';
    
    const badges = [];
    if (streak >= 7) badges.push('<span class="streak-badge">7-day streak</span>');
    if (streak >= 30) badges.push('<span class="streak-badge">30-day streak</span>');
    
    return badges.length > 0 ? `<div class="friend-badges">${badges.join('')}</div>` : '';
}

async function handleSearchFriend() {
    console.log('üîç Search friend clicked');
    const emailInput = document.getElementById('friendEmail');
    const email = emailInput.value.trim();
    
    console.log('üìß Email entered:', email);
    
    if (!email) {
        showNotification('Please enter an email address', 'error');
        return;
    }
    
    if (!validateEmail(email)) {
        showNotification('Please enter a valid email address', 'error');
        return;
    }
    
    // Show loading state
    const button = document.getElementById('searchFriendBtn');
    const originalContent = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        console.log('üåê Fetching /api/friends/search with email:', email);
        const response = await fetch('/api/friends/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: email })
        });
        
        console.log('üì° Response status:', response.status);
        const data = await response.json();
        console.log('üì¶ Response data:', data);
        
        if (data.success && data.user) {
            displaySearchResult(data.user);
        } else {
            showNotification(data.error || 'User not found', 'error');
            document.getElementById('searchResults').innerHTML = '';
        }
    } catch (error) {
        console.error('üí• Error searching friend:', error);
        showNotification('An error occurred. Please try again.', 'error');
    } finally {
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

function displaySearchResult(user) {
    console.log('üë§ Displaying user:', user);
    const searchResults = document.getElementById('searchResults');
    
    searchResults.innerHTML = `
        <div class="search-result-card">
            <div class="user-info">
                <div class="user-icon">üë§</div>
                <div class="user-details">
                    <h4>${user.displayName || 'User'}</h4>
                    <p>${user.email}</p>
                    ${user.stats ? `<p class="user-streak">üî• ${user.stats.currentStreak || 0} day streak</p>` : ''}
                </div>
            </div>
            <button class="btn-add-user" onclick="sendFriendRequest('${user.uid}', '${user.displayName || user.email}')">
                <i class="fas fa-paper-plane"></i>
                Send Request
            </button>
        </div>
    `;
}

async function sendFriendRequest(friendUid, friendName) {
    console.log('üì§ Sending friend request to:', friendUid, friendName);
    
    try {
        const response = await fetch('/api/friends/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ friendUid: friendUid })
        });
        
        console.log('üì° Send request response status:', response.status);
        const data = await response.json();
        console.log('üì¶ Send request response data:', data);
        
        if (data.success) {
            showNotification(data.message || `Friend request sent to ${friendName}!`, 'success');
            document.getElementById('searchResults').innerHTML = '';
            document.getElementById('friendEmail').value = '';
            // Reload friends list
            await loadFriends();
        } else {
            showNotification(data.error || 'Failed to send friend request', 'error');
        }
    } catch (error) {
        console.error('üí• Error sending friend request:', error);
        showNotification('An error occurred. Please try again.', 'error');
    }
}

async function acceptFriendRequest(requesterUid, requesterName) {
    console.log('‚úÖ Accepting friend request from:', requesterUid);
    
    try {
        const response = await fetch('/api/friends/accept', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ requesterUid: requesterUid })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message || `You are now friends with ${requesterName}!`, 'success');
            await loadFriends();
        } else {
            showNotification(data.error || 'Failed to accept request', 'error');
        }
    } catch (error) {
        console.error('üí• Error accepting friend request:', error);
        showNotification('An error occurred. Please try again.', 'error');
    }
}

async function declineFriendRequest(requesterUid) {
    console.log('‚ùå Declining friend request from:', requesterUid);
    
    try {
        const response = await fetch('/api/friends/decline', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ requesterUid: requesterUid })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message || 'Friend request declined', 'info');
            await loadFriends();
        } else {
            showNotification(data.error || 'Failed to decline request', 'error');
        }
    } catch (error) {
        console.error('üí• Error declining friend request:', error);
        showNotification('An error occurred. Please try again.', 'error');
    }
}

async function cancelFriendRequest(targetUid) {
    console.log('üö´ Canceling friend request to:', targetUid);
    
    try {
        const response = await fetch('/api/friends/cancel', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ targetUid: targetUid })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message || 'Friend request canceled', 'info');
            await loadFriends();
        } else {
            showNotification(data.error || 'Failed to cancel request', 'error');
        }
    } catch (error) {
        console.error('üí• Error canceling friend request:', error);
        showNotification('An error occurred. Please try again.', 'error');
    }
}

async function removeFriend(friendUid, friendName) {
    if (!confirm(`Remove ${friendName} from your friends list?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/friends/${friendUid}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(`${friendName} removed from friends`, 'success');
            // Reload friends list
            await loadFriends();
        } else {
            showNotification(data.error || 'Failed to remove friend', 'error');
        }
    } catch (error) {
        console.error('Error removing friend:', error);
        showNotification('An error occurred. Please try again.', 'error');
    }
}

function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 16px 24px;
        background: ${type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}
</script>

<style>
.friends-page-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 24px;
}

.add-friend-card,
.my-friends-card {
    background: white;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    margin-bottom: 24px;
}

.add-friend-title,
.my-friends-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    color: #1f2937;
}

.add-friend-form {
    display: flex;
    gap: 12px;
}

.friend-input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
    transition: border-color 0.2s;
}

.friend-input:focus {
    border-color: #6366f1;
}

.btn-search-friend {
    padding: 12px 24px;
    background: #6366f1;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}

.btn-search-friend:hover {
    background: #4f46e5;
}

.btn-search-friend:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.search-results {
    margin-top: 16px;
}

.search-result-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.user-icon {
    width: 48px;
    height: 48px;
    background: #e0e7ff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
}

.user-details h4 {
    margin: 0 0 4px 0;
    font-size: 16px;
    color: #1f2937;
}

.user-details p {
    margin: 0;
    font-size: 14px;
    color: #6b7280;
}

.user-streak {
    color: #f59e0b !important;
    font-weight: 500;
}

.btn-add-user {
    padding: 8px 16px;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background 0.2s;
}

.btn-add-user:hover {
    background: #059669;
}

/* Friend Requests Section */
.friend-requests-card {
    background: #fff;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 24px;
}

.requests-title {
    margin: 0 0 20px 0;
    font-size: 18px;
    font-weight: 600;
    color: #1f2937;
}

.requests-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.request-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #f9fafb;
}

.request-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.request-actions {
    display: flex;
    gap: 8px;
}

.btn-accept {
    padding: 8px 16px;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
}

.btn-accept:hover {
    background: #059669;
}

.btn-decline {
    padding: 8px 16px;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
}

.btn-decline:hover {
    background: #dc2626;
}

.friends-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.friend-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s;
}

.friend-card:hover {
    border-color: #d1d5db;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.friend-info {
    flex: 1;
}

.friend-name {
    font-size: 16px;
    font-weight: 600;
    color: #1f2937;
    margin-bottom: 4px;
}

.friend-streak {
    font-size: 14px;
    color: #6b7280;
}

.friend-badges {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.streak-badge {
    display: inline-block;
    padding: 4px 12px;
    background: #dbeafe;
    color: #1e40af;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.btn-remove-friend {
    padding: 8px 12px;
    background: #fee2e2;
    color: #dc2626;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-remove-friend:hover {
    background: #fecaca;
}

.empty-state {
    text-align: center;
    padding: 48px 24px;
    color: #9ca3af;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

/* Request labels and cancel button */
.request-label {
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 500;
    margin-left: 8px;
}

.request-label.incoming {
    background: #dbeafe;
    color: #1e40af;
}

.request-label.outgoing {
    background: #fef3c7;
    color: #d97706;
}

.btn-cancel {
    padding: 8px 16px;
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.2s;
}

.btn-cancel:hover {
    background: #4b5563;
}

.outgoing-request {
    border-left: 3px solid #f59e0b;
}

.incoming-request {
    border-left: 3px solid #3b82f6;
}
</style>
{% endblock %}