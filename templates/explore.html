{% extends "base_dashboard.html" %}

{% block title %}Explore - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
    <div class="explore-page-content">
    <div class="explore-container">
        <div class="explore-header">
            <h2 class="explore-title">
                <i class="fas fa-search explore-icon"></i>
                Explore Habits
            </h2>
            <p class="explore-subtitle">Discover popular habits and add them to your routine. Each habit includes details about difficulty and benefits.</p>
        </div>
        
        <div class="habits-grid">
            <!-- Habit Card 1: Drink Water -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Drink 8 glasses of water</h3>
                    <div class="habit-tags">
                        <span class="tag wellness">Wellness</span>
                        <span class="tag daily">Daily</span>
                        <span class="tag easy">Easy</span>
                    </div>
                    <p class="habit-description">Stay hydrated throughout the day by drinking at least 8 glasses of water. Proper hydration improves...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="water">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
            
            <!-- Habit Card 2: Exercise -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Exercise for 30 minutes</h3>
                    <div class="habit-tags">
                        <span class="tag fitness">Fitness</span>
                        <span class="tag daily">Daily</span>
                        <span class="tag medium">Medium</span>
                    </div>
                    <p class="habit-description">Engage in physical activity for at least 30 minutes. This can include walking, running, yoga, or any...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="exercise">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
            
            <!-- Habit Card 3: Reading -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Read for 20 minutes</h3>
                    <div class="habit-tags">
                        <span class="tag learning">Learning</span>
                        <span class="tag daily">Daily</span>
                        <span class="tag easy">Easy</span>
                    </div>
                    <p class="habit-description">Dedicate 20 minutes daily to reading. This habit expands knowledge, improves vocabulary, and provide...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="reading">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
            
            <!-- Habit Card 4: Gratitude Journaling -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Practice gratitude journaling</h3>
                    <div class="habit-tags">
                        <span class="tag wellness">Wellness</span>
                        <span class="tag daily">Daily</span>
                        <span class="tag easy">Easy</span>
                    </div>
                    <p class="habit-description">Write down three things you are grateful for each day. This practice has been shown to improve menta...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="gratitude">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
            
            <!-- Habit Card 5: Learn Language -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Learn a new language</h3>
                    <div class="habit-tags">
                        <span class="tag learning">Learning</span>
                        <span class="tag daily">Daily</span>
                        <span class="tag hard">Hard</span>
                    </div>
                    <p class="habit-description">Spend time each day learning a new language through apps, courses, or practice. This challenging hab...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="language">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
            
            <!-- Habit Card 6: Meal Prep -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Meal prep for the week</h3>
                    <div class="habit-tags">
                        <span class="tag productivity">Productivity</span>
                        <span class="tag weekly">Weekly</span>
                        <span class="tag medium">Medium</span>
                    </div>
                    <p class="habit-description">Prepare your meals in advance for the upcoming week. This saves time, money, and helps maintain a he...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="mealprep">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
            
            <!-- Habit Card 7: Social Media Detox -->
            <div class="habit-card">
                <div class="habit-info">
                    <h3 class="habit-name">Social media detox hour</h3>
                    <div class="habit-tags">
                        <span class="tag wellness">Wellness</span>
                        <span class="tag daily">Daily</span>
                        <span class="tag medium">Medium</span>
                    </div>
                    <p class="habit-description">Take a break from social media for at least one hour each day. Use this time for self-reflection, ho...</p>
                </div>
                <div class="habit-actions">
                    <button class="btn-details">
                        <i class="fas fa-info-circle"></i>
                        Details
                    </button>
                    <button class="btn-add-habit" data-habit="detox">
                        <i class="fas fa-plus-circle"></i>
                        Add Habit
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Details Modal -->
<div id="habitDetailsModal" class="habit-modal" style="display: none;">
    <div class="habit-modal-content">
        <div class="habit-modal-header">
            <h2 id="modalHabitName"></h2>
            <span class="habit-modal-close" onclick="closeDetailsModal()">&times;</span>
        </div>
        <div class="habit-modal-body">
            <div id="modalHabitTags" class="habit-tags"></div>
            
            <div class="modal-section">
                <h3>Description</h3>
                <p id="modalHabitDescription"></p>
            </div>
            
            <div class="modal-section">
                <h3>Benefits</h3>
                <ul id="modalHabitBenefits"></ul>
            </div>

            <!-- üîß NEW: Edit form like dashboard -->
            <div class="modal-section">
                <h3>Edit habit settings</h3>

                <div class="modal-form-group">
                    <label for="exploreEditName">Habit Name</label>
                    <input type="text" id="exploreEditName" class="modal-form-input" />
                </div>

                <div class="modal-form-group">
                    <label for="exploreEditDescription">Purpose / Description</label>
                    <textarea id="exploreEditDescription"
                              class="modal-form-textarea"
                              rows="2"></textarea>
                </div>

                <div class="modal-form-group">
                    <label for="exploreEditFrequency">Frequency</label>
                    <select id="exploreEditFrequency" class="modal-form-select">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>

                <div id="exploreEditCustomGroup" class="modal-form-row" style="display:none;">
                    <div class="modal-form-group half">
                        <label for="exploreEditCustomValue">Every</label>
                        <input type="number"
                               id="exploreEditCustomValue"
                               class="modal-form-input"
                               min="1" />
                    </div>
                    <div class="modal-form-group half">
                        <label for="exploreEditCustomUnit">Unit</label>
                        <select id="exploreEditCustomUnit" class="modal-form-select">
                            <option value="days">Days</option>
                            <option value="weeks">Weeks</option>
                            <option value="months">Months</option>
                        </select>
                    </div>
                </div>

                <div class="modal-form-group">
                    <label for="exploreEditReminderTime">Preferred Complete Time</label>
                    <input type="time" id="exploreEditReminderTime" class="modal-form-input" />
                </div>

                <div class="modal-form-row row-between">
                    <div>
                        <div class="modal-form-label-main">Visibility</div>
                        <div class="modal-form-hint">Private habits are only visible to you.</div>
                    </div>
                    <label class="switch">
                        <input type="checkbox" id="exploreEditIsPrivate" />
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn-modal-add" id="modalAddButton">
                    <i class="fas fa-plus-circle"></i>
                    Add Habit
                </button>
                <!-- NEW: Save changes button -->
                <button class="btn-modal-edit" id="modalEditButton">
                    <i class="fas fa-save"></i>
                    Save changes
                </button>
            </div>
        </div>
    </div>
</div>


<style>
.habit-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.habit-modal-content {
    background: white;
    border-radius: 15px;
    max-width: 600px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.habit-modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.habit-modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    color: #1f2937;
}

.habit-modal-close {
    font-size: 1.8rem;
    color: #9ca3af;
    cursor: pointer;
    line-height: 1;
}

.habit-modal-close:hover {
    color: #374151;
}

.habit-modal-body {
    padding: 2rem;
}

.modal-section {
    margin-bottom: 1.5rem;
}

.modal-section h3 {
    font-size: 1.1rem;
    color: #374151;
    margin-bottom: 0.75rem;
}

.modal-section p {
    color: #6b7280;
    line-height: 1.6;
}

.modal-section ul {
    list-style: none;
    padding: 0;
}

.modal-section ul li {
    padding: 0.5rem 0;
    color: #6b7280;
    display: flex;
    align-items: center;
}

.modal-section ul li:before {
    content: "‚Ä¢";
    color: #6366f1;
    font-weight: bold;
    font-size: 1.5rem;
    margin-right: 0.75rem;
}

.modal-actions {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
    gap: 0.75rem;
}

.btn-modal-add {
    background: #6366f1;
    color: white;
    border: none;
    padding: 0.875rem 2rem;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.btn-modal-add:hover {
    background: #5856eb;
    transform: translateY(-2px);
}

.btn-modal-add.added {
    background: #10b981;
    cursor: pointer;
}

.btn-modal-add.added:hover {
    background: #059669;
    transform: translateY(-2px);
}

.btn-modal-add.remove-mode {
    background: #ef4444;
}

.btn-modal-add.remove-mode:hover {
    background: #dc2626;
}

/* ‚úèÔ∏è Edit button style */
.btn-modal-edit {
    background: #f9fafb;
    color: #374151;
    border: 1px solid #d1d5db;
    padding: 0.875rem 1.75rem;
    border-radius: 10px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
}

.btn-modal-edit:hover {
    background: #e5e7eb;
    transform: translateY(-2px);
}

.btn-add-habit.added {
    background: #10b981;
    color: white;
    cursor: pointer;
}

.btn-add-habit.added:hover {
    background: #059669;
    transform: translateY(-2px);
}
</style>

{% endblock %}

{% block scripts %}
<script>
// Store user's habits fetched from backend
let userGoals = {};
let addedHabits = [];
// üîπ Êñ∞Â¢ûÔºöÂÆåÊï¥ÁöÑ habit Ë≥áÊñôÔºå‰ª• habitType Áï∂ key
let userHabitsMap = {};

document.addEventListener('DOMContentLoaded', function() {
    // Fetch user's existing habits and restore button states
    fetchUserGoalsAndRestoreStates();
    
    // Handle details buttons
    document.querySelectorAll('.btn-details').forEach(button => {
        button.addEventListener('click', function() {
            const habitCard = this.closest('.habit-card');
            const habitType = habitCard.querySelector('.btn-add-habit').getAttribute('data-habit');
            showHabitDetails(habitType);
        });
    });
    
    // Handle add habit buttons
    document.querySelectorAll('.btn-add-habit').forEach(button => {
        button.addEventListener('click', function() {
            const habitType = this.getAttribute('data-habit');
            if (this.classList.contains('added')) {
                // Remove habit
                handleRemoveHabit(habitType, this);
            } else {
                // Add habit
                handleAddHabit(habitType, this);
            }
        });
    });

    // toggle custom frequency UI in explore modal
    const freqSelect = document.getElementById('exploreEditFrequency');
    const customGroup = document.getElementById('exploreEditCustomGroup');
    if (freqSelect && customGroup) {
        freqSelect.addEventListener('change', () => {
            customGroup.style.display = freqSelect.value === 'custom' ? 'flex' : 'none';
        });
    }

});

// Fetch user's habits and restore states
async function fetchUserGoalsAndRestoreStates() {
    try {
        console.log('üîÑ Fetching user habits from backend...');
        const response = await fetch('/api/habits');
        const result = await response.json();
        
        if (result.success && result.habits) {
            console.log(`‚úÖ Found ${result.habits.length} habits`);
            console.log('üìã All habits:', result.habits);
            
            result.habits.forEach(habit => {
                const habitType = extractHabitType(habit);
                console.log(`üîç Habit: "${habit.name}" ‚Üí Type: "${habitType}"`);
                if (habitType) {
                    if (!addedHabits.includes(habitType)) {
                        addedHabits.push(habitType);
                    }
                    userGoals[habitType] = habit.id;
                    userHabitsMap[habitType] = habit;  // Â≠òÊï¥ÂÄã habit Áâ©‰ª∂ÔºåÁµ¶ Edit Áî®
                }
            });
            
            console.log('‚úÖ Added habits array:', addedHabits);
            console.log('‚úÖ User goals map:', userGoals);
            
            restoreButtonStates();
        } else {
            console.log('üì≠ No habits found');
        }
    } catch (error) {
        console.error('‚ùå Error fetching habits:', error);
    }
}

// Extract habit type from habit data
function extractHabitType(habit) {
    const name = (habit.name || habit.title || '').toLowerCase();
    
    if (name.includes('water') || name.includes('8 glasses')) return 'water';
    if (name.includes('exercise') || name.includes('workout') || name.includes('30 minutes')) return 'exercise';
    if (name.includes('meditation') || name.includes('mindfulness')) return 'meditation';
    if (name.includes('reading') || name.includes('book')) return 'reading';
    if (name.includes('sleep') || name.includes('7 hours')) return 'sleep';
    if (name.includes('gratitude') || name.includes('journal')) return 'gratitude';
    // üîß ‰øÆÊ≠£ÔºöË∑üÂç°Áâá data-habit="detox" / template key "detox" ‰∏ÄËá¥
    if (name.includes('social media') || name.includes('detox')) return 'detox';
    if (name.includes('vegetables') || name.includes('veggies')) return 'vegetables';
    
    return null;
}

// Restore button states based on backend
function restoreButtonStates() {
    document.querySelectorAll('.btn-add-habit').forEach(button => {
        const habitType = button.getAttribute('data-habit');
        if (addedHabits.includes(habitType)) {
            button.innerHTML = '<i class="fas fa-times-circle"></i> Remove';
            button.classList.add('added');
        }
    });
}

// Show habit details modal
function showHabitDetails(habitType) {
    const habitData = getHabitTemplate(habitType);
    
    if (!habitData) {
        alert('Habit details not found');
        return;
    }
    
    // È°ØÁ§∫ template ÁöÑÁ∞°‰ªã / tags / benefits
    document.getElementById('modalHabitName').textContent = habitData.name;
    document.getElementById('modalHabitDescription').textContent = habitData.description;
    
    const tagsHtml = `
        <span class="tag ${habitData.category.toLowerCase()}">${habitData.category}</span>
        <span class="tag ${habitData.frequency.toLowerCase()}">${habitData.frequency}</span>
        <span class="tag ${habitData.difficulty.toLowerCase()}">${habitData.difficulty}</span>
    `;
    document.getElementById('modalHabitTags').innerHTML = tagsHtml;
    
    const benefitsHtml = habitData.benefits.map(benefit => `<li>${benefit}</li>`).join('');
    document.getElementById('modalHabitBenefits').innerHTML = benefitsHtml;
    
    // ===== Add / Remove ÊåâÈàïÁãÄÊÖã =====
    const modalAddButton = document.getElementById('modalAddButton');
    modalAddButton.setAttribute('data-habit', habitType);
    
    if (addedHabits.includes(habitType)) {
        modalAddButton.innerHTML = '<i class="fas fa-times-circle"></i> Remove Habit';
        modalAddButton.classList.add('added', 'remove-mode');
        modalAddButton.disabled = false;
        modalAddButton.onclick = function() {
            removeHabitFromModal(habitType);
        };
    } else {
        modalAddButton.innerHTML = '<i class="fas fa-plus-circle"></i> Add Habit';
        modalAddButton.classList.remove('added', 'remove-mode');
        modalAddButton.disabled = false;
        modalAddButton.onclick = function() {
            addHabitFromModal(habitType);
        };
    }

    // ===== Prefill Á∑®ËºØË°®ÂñÆ =====
    prefillExploreEditForm(habitType);

    // ===== Save changes ÊåâÈàïÁ∂Å handler =====
    const modalEditButton = document.getElementById('modalEditButton');
    if (modalEditButton) {
        modalEditButton.onclick = function() {
            saveExploreHabit(habitType);
        };
        if (addedHabits.includes(habitType)) {
            modalEditButton.innerHTML = '<i class="fas fa-save"></i> Save changes';
        } else {
            modalEditButton.innerHTML = '<i class="fas fa-save"></i> Save & add';
        }
    }
    
    // È°ØÁ§∫ modal
    document.getElementById('habitDetailsModal').style.display = 'flex';
}

function prefillExploreEditForm(habitType) {
    const template = getHabitTemplate(habitType);
    const existing = userHabitsMap[habitType] || null;
    const base = existing || template;

    if (!base) return;

    const nameInput = document.getElementById('exploreEditName');
    const descInput = document.getElementById('exploreEditDescription');
    const freqSelect = document.getElementById('exploreEditFrequency');
    const customGroup = document.getElementById('exploreEditCustomGroup');
    const customValue = document.getElementById('exploreEditCustomValue');
    const customUnit = document.getElementById('exploreEditCustomUnit');
    const remTime = document.getElementById('exploreEditReminderTime');
    const isPrivateToggle = document.getElementById('exploreEditIsPrivate');

    const freqRaw = (base.frequency || template.frequency || 'daily').toLowerCase();

    if (nameInput) nameInput.value = base.name || base.title || template.name || '';
    if (descInput) descInput.value = base.description || template.description || '';
    if (freqSelect) freqSelect.value = ['daily','weekly','monthly','custom'].includes(freqRaw) ? freqRaw : 'daily';

    if (freqSelect && customGroup) {
        customGroup.style.display = freqSelect.value === 'custom' ? 'flex' : 'none';
    }

    if (customValue) {
        customValue.value = base.customFrequencyValue || '';
    }
    if (customUnit) {
        customUnit.value = base.customFrequencyUnit || 'days';
    }

    if (remTime) {
        remTime.value = base.reminderTime || '';
    }

    if (isPrivateToggle) {
        isPrivateToggle.checked = !!base.isPrivate;
    }
}

function saveExploreHabit(habitType) {
    const template = getHabitTemplate(habitType);
    const existing = userHabitsMap[habitType] || null;
    const base = existing || template || {};

    const nameInput = document.getElementById('exploreEditName');
    const descInput = document.getElementById('exploreEditDescription');
    const freqSelect = document.getElementById('exploreEditFrequency');
    const customGroup = document.getElementById('exploreEditCustomGroup');
    const customValue = document.getElementById('exploreEditCustomValue');
    const customUnit = document.getElementById('exploreEditCustomUnit');
    const remTime = document.getElementById('exploreEditReminderTime');
    const isPrivateToggle = document.getElementById('exploreEditIsPrivate');

    const name = (nameInput?.value || '').trim();
    const description = (descInput?.value || '').trim();
    const frequency = (freqSelect?.value || 'daily').toLowerCase();

    if (!name) {
        alert('Habit name is required');
        return;
    }

    const reminderTime = remTime ? remTime.value : '';
    const isPrivate = !!(isPrivateToggle && isPrivateToggle.checked);

    const payload = {
        name,
        description,
        frequency,
        category: base.category || (template && template.category) || 'General',
        reminderEnabled: !!reminderTime,
        reminderTime: reminderTime || null,
        isPrivate
    };

    if (frequency === 'custom') {
        payload.customFrequencyValue = customValue ? Number(customValue.value || 0) : null;
        payload.customFrequencyUnit = customUnit ? (customUnit.value || 'days') : 'days';
    } else {
        payload.customFrequencyValue = null;
        payload.customFrequencyUnit = null;
    }

    // ===== Â∑≤Â≠òÂú® ‚Üí Êõ¥Êñ∞ habit =====
    if (existing && existing.id) {
        fetch(`/api/habits/${existing.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                throw new Error(data.error || 'Failed to update habit');
            }

            userHabitsMap[habitType] = { ...existing, ...payload };

            // Êõ¥Êñ∞ modal È°ØÁ§∫
            document.getElementById('modalHabitName').textContent = name;
            document.getElementById('modalHabitDescription').textContent = description;

            if (typeof showSuccessMessage === 'function') {
                showSuccessMessage('Habit updated successfully ‚úèÔ∏è');
            } else {
                alert('Habit updated successfully ‚úèÔ∏è');
            }
        })
        .catch(err => {
            console.error('Error updating habit:', err);
            alert('Failed to update habit. Please try again.');
        });

    } else {
        // ===== Â∞öÊú™Âä†ÂÖ• ‚Üí Áõ¥Êé•Áî®Á∑®ËºØÂæåÂÖßÂÆπÊñ∞Â¢û habit ‰∏¶Ë¶ñÁÇ∫Âä†ÂÖ• =====
        fetch('/api/habits', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (!(data.success || data.habitId || data.id)) {
                throw new Error(data.error || 'Failed to create habit');
            }

            const newId = data.habitId || data.id;
            userGoals[habitType] = newId;
            userHabitsMap[habitType] = { id: newId, ...payload };
            if (!addedHabits.includes(habitType)) {
                addedHabits.push(habitType);
            }

            // Êõ¥Êñ∞Âç°Áâá‰∏äÁöÑ Add ÊåâÈàï
            const cardBtn = document.querySelector(`.btn-add-habit[data-habit="${habitType}"]`);
            if (cardBtn) {
                cardBtn.innerHTML = '<i class="fas fa-times-circle"></i> Remove';
                cardBtn.classList.add('added');
            }

            // Êõ¥Êñ∞ modal Add ÊåâÈàï
            const modalAddButton = document.getElementById('modalAddButton');
            if (modalAddButton) {
                modalAddButton.innerHTML = '<i class="fas fa-times-circle"></i> Remove Habit';
                modalAddButton.classList.add('added', 'remove-mode');
                modalAddButton.onclick = function() {
                    removeHabitFromModal(habitType);
                };
            }

            // Êõ¥Êñ∞È°ØÁ§∫
            document.getElementById('modalHabitName').textContent = name;
            document.getElementById('modalHabitDescription').textContent = description;

            if (typeof showSuccessMessage === 'function') {
                showSuccessMessage(`${name} created and added to your habits! üéâ`);
            } else {
                alert(`${name} created and added to your habits! üéâ`);
            }
        })
        .catch(err => {
            console.error('Error creating habit:', err);
            alert('Failed to create habit. Please try again.');
        });
    }
}

// Close habit details modal
function closeDetailsModal() {
    document.getElementById('habitDetailsModal').style.display = 'none';
}

// Add habit from modal
function addHabitFromModal(habitType) {
    const modalButton = document.getElementById('modalAddButton');
    const cardButton = document.querySelector(`.btn-add-habit[data-habit="${habitType}"]`);
    
    handleAddHabit(habitType, modalButton, cardButton);
}

// Remove habit from modal
function removeHabitFromModal(habitType) {
    const modalButton = document.getElementById('modalAddButton');
    const cardButton = document.querySelector(`.btn-add-habit[data-habit="${habitType}"]`);
    
    handleRemoveHabit(habitType, modalButton, cardButton);
}

// Handle adding habits
function handleAddHabit(habitType, buttonElement, cardButton = null) {
    const habitData = getHabitTemplate(habitType);
    
    if (!habitData) {
        alert('Habit template not found');
        return;
    }
    
    // Show loading state
    const originalContent = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
    buttonElement.disabled = true;
    
    fetch('/api/habits', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: habitData.name,
            description: habitData.description,
            category: habitData.category,
            frequency: habitData.frequency.toLowerCase()
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.habitId || data.id) {
            console.log('‚úÖ Habit added:', data);
            
            // Update UI
            buttonElement.innerHTML = '<i class="fas fa-times-circle"></i> Remove';
            buttonElement.classList.add('added');
            buttonElement.classList.remove('remove-mode');
            buttonElement.disabled = false;
            
            const cardBtn = cardButton || document.querySelector(`.btn-add-habit[data-habit="${habitType}"]`);
            if (cardBtn) {
                cardBtn.innerHTML = '<i class="fas fa-times-circle"></i> Remove';
                cardBtn.classList.add('added');
            }
            
            if (!addedHabits.includes(habitType)) {
                addedHabits.push(habitType);
            }
            
            const newId = data.habitId || data.id;
            userGoals[habitType] = newId;
            userHabitsMap[habitType] = {
                id: newId,
                name: habitData.name,
                description: habitData.description,
                category: habitData.category,
                frequency: habitData.frequency.toLowerCase()
            };
            
            if (typeof showSuccessMessage === 'function') {
                showSuccessMessage(`${habitData.name} added to your habits! üéâ`);
            } else {
                alert(`${habitData.name} added to your habits! üéâ`);
            }
        } else {
            throw new Error(data.error || 'Failed to add habit');
        }
    })
    .catch(error => {
        console.error('Error adding habit:', error);
        buttonElement.innerHTML = originalContent;
        buttonElement.disabled = false;
        alert('Failed to add habit. Please try again.');
    });
}

// Handle removing habits
function handleRemoveHabit(habitType, buttonElement, cardButton = null) {
    const habitData = getHabitTemplate(habitType);
    
    if (!habitData) {
        alert('Habit template not found');
        return;
    }
    
    const originalContent = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';
    buttonElement.disabled = true;
    
    const habitId = userGoals[habitType];
    
    if (!habitId) {
        console.log('‚ö†Ô∏è No habitId found for habit type:', habitType);
        alert('This habit is not in your collection yet.');
        buttonElement.innerHTML = originalContent;
        buttonElement.disabled = false;
        return;
    }
    
    fetch(`/api/habits/${habitId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Habit removed:', habitId);
            updateRemoveUI(habitType, buttonElement, cardButton, habitData);
        } else {
            throw new Error(data.error || 'Failed to remove habit');
        }
    })
    .catch(error => {
        console.error('‚ùå Error removing habit:', error);
        buttonElement.innerHTML = originalContent;
        buttonElement.disabled = false;
        alert('Failed to remove habit. Please try again.');
    });
}

// Update UI after removing habit
function updateRemoveUI(habitType, buttonElement, cardButton, habitData) {
    buttonElement.innerHTML = '<i class="fas fa-plus-circle"></i> Add Habit';
    buttonElement.classList.remove('added', 'remove-mode');
    buttonElement.disabled = false;
    
    const cardBtn = cardButton || document.querySelector(`.btn-add-habit[data-habit="${habitType}"]`);
    if (cardBtn) {
        cardBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Habit';
        cardBtn.classList.remove('added');
    }
    
    addedHabits = addedHabits.filter(habit => habit !== habitType);
    delete userGoals[habitType];
    delete userHabitsMap[habitType];
    
    const modal = document.getElementById('habitDetailsModal');
    if (modal && modal.style.display === 'flex') {
        const modalButton = document.getElementById('modalAddButton');
        if (modalButton && modalButton.getAttribute('data-habit') === habitType) {
            modalButton.innerHTML = '<i class="fas fa-plus-circle"></i> Add Habit';
            modalButton.classList.remove('added', 'remove-mode');
            modalButton.onclick = function() {
                addHabitFromModal(habitType);
            };
        }
    }
    
    if (typeof showSuccessMessage === 'function') {
        showSuccessMessage(`${habitData.name} removed from your habits`);
    } else {
        alert(`${habitData.name} removed from your habits`);
    }
    
    console.log('Habit removed:', habitType);
}

// Get habit template data with benefits
function getHabitTemplate(habitType) {
    const templates = {
        water: {
            name: 'Drink 8 glasses of water',
            category: 'Wellness',
            frequency: 'Daily',
            difficulty: 'Easy',
            description: 'Stay hydrated throughout the day by drinking at least 8 glasses of water. Proper hydration improves energy, skin health, and overall well-being.',
            benefits: [
                'Improved energy',
                'Better skin',
                'Enhanced focus'
            ],
            reminders: ['09:00', '13:00', '17:00']
        },
        exercise: {
            name: 'Exercise for 30 minutes',
            category: 'Fitness',
            frequency: 'Daily',
            difficulty: 'Medium',
            description: 'Engage in physical activity for at least 30 minutes. This can include walking, running, yoga, or any other form of exercise.',
            benefits: [
                'Improved cardiovascular health',
                'Weight management',
                'Better mood and mental health',
                'Increased energy levels'
            ],
            reminders: ['07:00']
        },
        reading: {
            name: 'Read for 20 minutes',
            category: 'Learning',
            frequency: 'Daily',
            difficulty: 'Easy',
            description: 'Dedicate 20 minutes daily to reading. This habit expands knowledge, improves vocabulary, and provides mental stimulation.',
            benefits: [
                'Expanded knowledge',
                'Improved vocabulary',
                'Better focus and concentration',
                'Stress reduction'
            ],
            reminders: ['20:00']
        },
        gratitude: {
            name: 'Practice gratitude journaling',
            category: 'Wellness',
            frequency: 'Daily',
            difficulty: 'Easy',
            description: 'Write down three things you are grateful for each day. This practice has been shown to improve mental health and overall life satisfaction.',
            benefits: [
                'Improved mental health',
                'Better sleep quality',
                'Increased happiness',
                'Enhanced relationships'
            ],
            reminders: ['21:00']
        },
        language: {
            name: 'Learn a new language',
            category: 'Learning',
            frequency: 'Daily',
            difficulty: 'Hard',
            description: 'Spend time each day learning a new language through apps, courses, or practice. Consistent daily practice is key to language acquisition.',
            benefits: [
                'Enhanced cognitive abilities',
                'Career opportunities',
                'Cultural understanding',
                'Improved memory'
            ],
            reminders: ['18:00']
        },
        mealprep: {
            name: 'Meal prep for the week',
            category: 'Productivity',
            frequency: 'Weekly',
            difficulty: 'Medium',
            description: 'Prepare your meals in advance for the upcoming week. This saves time, money, and helps maintain a healthy diet.',
            benefits: [
                'Time savings during the week',
                'Healthier eating habits',
                'Cost effective',
                'Reduced food waste'
            ],
            reminders: ['10:00']
        },
        detox: {
            name: 'Social media detox hour',
            category: 'Wellness',
            frequency: 'Daily',
            difficulty: 'Medium',
            description: 'Take a break from social media for at least one hour each day. Use this time for activities that promote mental well-being.',
            benefits: [
                'Reduced anxiety and stress',
                'Better focus',
                'Improved real-life connections',
                'More productive time'
            ],
            reminders: ['19:00']
        }
    };
    
    return templates[habitType] || null;
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('habitDetailsModal');
    if (event.target === modal) {
        closeDetailsModal();
    }
});
</script>
{% endblock %}
