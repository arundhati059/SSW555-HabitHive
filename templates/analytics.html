{% extends "base_dashboard.html" %}

{% block title %}Analytics - HabitHive{% endblock %}

{% block content %}
<div class="analytics-container">
    <h2 class="page-title">ðŸ“Š Habit Analytics</h2>
    <p class="subtitle">History of your completions and a simple calendar view.</p>

    <!-- 30-day calendar + toggle -->
    <div class="calendar-header">
        <h3 class="section-title">ðŸ“… Last 30-Day Calendar</h3>
        <button id="toggleCalendarView" class="view-btn calendar-toggle">
            Square calendar view
        </button>
    </div>

    <div id="calendarGrid" class="calendar-grid">
        <!-- filled by JS -->
    </div>

    <!-- é»žæ—¥æœŸå¾Œé¡¯ç¤ºç•¶å¤©å®Œæˆå“ªäº› habit -->
    <div id="dayDetailsBox" class="details-box hidden">
        <h4 id="detailsDate"></h4>
        <ul id="detailsList"></ul>
    </div>

    <hr>

    <!-- ===================== DAILY COMPLETION HISTORY (list view) ===================== -->
    <div id="historySection">
        <h3 class="section-title">ðŸ“œ Daily Completion History</h3>
        <p class="subtitle">
            View a history list of your daily completions and switch between different time ranges.
        </p>

        <div class="view-controls">
            <button class="view-btn active" data-period="week">This Week</button>
            <button class="view-btn" data-period="day">Today</button>
            <button class="view-btn" data-period="month">Last 30 Days</button>
        </div>

        <div id="dailyHistoryList" class="history-list">
            <!-- filled by JS -->
        </div>
    </div>

{% endblock %}

{% block scripts %}
{{ super() }}
<style>
.analytics-container {
    max-width: 900px;
    margin: 40px auto;
}

/* calendar */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}
.calendar-grid {
    display: grid;
    grid-template-columns: repeat(15, 18px);
    gap: 6px;
    margin-bottom: 25px;
}
.day-box {
    width: 18px;
    height: 18px;
    background: #dadada;
    border-radius: 4px;
    cursor: pointer;
}
.day-box.done { background: #6a5af9; }
.day-box.today { border: 2px solid black; }

/* square calendar view */
.calendar-grid.square {
    grid-template-columns: repeat(7, 24px);
}
.calendar-grid.square .day-box {
    width: 24px;
    height: 24px;
}

/* day details */
.details-box {
    padding: 15px;
    background: #fff;
    border-radius: 10px;
    border: 1px solid #ddd;
    max-width: 400px;
    margin-top: 20px;
}
.hidden { display: none; }

/* history list */
.view-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
}
.view-btn {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: #f8f8f8;
    cursor: pointer;
    font-size: 0.9rem;
}
.view-btn.active {
    background: #6a5af9;
    color: #fff;
    border-color: #6a5af9;
}
.calendar-toggle {
    padding: 4px 10px;
    font-size: 0.85rem;
}

.history-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.history-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid #eee;
    background: #fafafa;
}
.history-date {
    font-weight: 600;
}
.history-meta {
    font-size: 0.85rem;
    color: #666;
}
.history-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-end;
}
.history-tag {
    padding: 3px 8px;
    border-radius: 999px;
    background: #e3e0ff;
    font-size: 0.8rem;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", async () => {
    try {
        const res = await fetch("/api/habits");
        const data = await res.json();

        const habits = (data.success && data.habits) ? data.habits : [];
        const calendarGrid = document.getElementById("calendarGrid");
        const historyList = document.getElementById("dailyHistoryList");
        const dayDetailsBox = document.getElementById("dayDetailsBox");
        const detailsDateEl = document.getElementById("detailsDate");
        const detailsListEl = document.getElementById("detailsList");

        // æ²’ habit å°±é¡¯ç¤ºç©ºç‹€æ…‹
        if (!habits.length) {
            calendarGrid.innerHTML = "<div class='history-meta'>No habits yet.</div>";
            historyList.innerHTML = "<div class='history-meta'>No history yet.</div>";
            return;
        }

        // ===== helper functions =====
        const today = new Date();

        function toKey(d) {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, "0");
            const day = String(d.getDate()).padStart(2, "0");
            return `${y}-${m}-${day}`;
        }

        function lastNDates(n) {
            const arr = [];
            const base = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            for (let i = 0; i < n; i++) {
                const d = new Date(base);
                d.setDate(base.getDate() - i);
                arr.push(toKey(d));
            }
            return arr.reverse(); // æœ€èˆŠåœ¨å‰ã€ä»Šå¤©åœ¨æœ€å¾Œ
        }

        function formatDisplayDate(dateStr) {
            const d = new Date(dateStr + "T00:00:00");
            return d.toLocaleDateString("en-US", {
                weekday: "short",
                month: "short",
                day: "numeric"
            });
        }

        // ===== ç”¨ currentStreak ç²—ç•¥æŽ¨æœ€è¿‘å¹¾å¤©çš„å®Œæˆæƒ…æ³ =====
        // å‡è¨­ï¼šcurrentStreak = 3 â†’ ä»Šå¤©ã€æ˜¨å¤©ã€å‰å¤©éƒ½å®Œæˆ
        const completionsByDate = {};   // { 'YYYY-MM-DD': [habitObjects...] }
        const todayKey = toKey(today);

        habits.forEach(h => {
            const streak = h.currentStreak || 0;
            for (let i = 0; i < streak; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const key = toKey(d);
                if (!completionsByDate[key]) completionsByDate[key] = [];
                completionsByDate[key].push(h);
            }
            // å¦‚æžœä»Šå¤© has isCompletedToday=true ä½† currentStreak=0ï¼Œä¹Ÿè£œä¸Šä»Šå¤©
            if (h.isCompletedToday && streak === 0) {
                if (!completionsByDate[todayKey]) completionsByDate[todayKey] = [];
                completionsByDate[todayKey].push(h);
            }
        });

        // ===== 30-day calendar =====
        // å°å·¥å…·ï¼šæŠŠ "2025-11-20" é€™ç¨®å­—ä¸²è½‰æˆ weekday + day
function getDateInfo(dateStr) {
    const d = new Date(dateStr + "T00:00:00");
    const weekday = d.toLocaleDateString("en-US", { weekday: "short" }); // Mon, Tue...
    const day = d.getDate(); // 1~31
    return { weekday, day };
}

// ===== 30-day calendar =====
const last30 = lastNDates(30);
calendarGrid.innerHTML = last30.map(dateStr => {
    const { weekday, day } = getDateInfo(dateStr);
    const done = (completionsByDate[dateStr] || []).length > 0;
    const isToday = (dateStr === todayKey);
    return `
    <div class="day-box ${done ? "done" : ""} ${isToday ? "today" : ""}"
         data-date="${dateStr}"
         title="${dateStr} - ${weekday}">
        <div class="day-label-week">${weekday}</div>
        <div class="day-label-date">${day}</div>
    </div>
    `;
}).join("");

        // é»žæ—¥æœŸ â†’ é¡¯ç¤ºç•¶å¤©å®Œæˆçš„ habits
        calendarGrid.addEventListener("click", (e) => {
            const box = e.target.closest(".day-box");
            if (!box) return;
            const dateStr = box.getAttribute("data-date");
            const list = completionsByDate[dateStr] || [];

            detailsDateEl.textContent = "ðŸ“… " + dateStr;
            detailsListEl.innerHTML = "";

            if (!list.length) {
                detailsListEl.innerHTML = "<li>No habits completed</li>";
            } else {
                list.forEach(h => {
                    detailsListEl.innerHTML += `<li>${h.name || "Habit"}</li>`;
                });
            }
            dayDetailsBox.classList.remove("hidden");
        });

        // ===== Daily history list (Today / Week / Month) =====
        function renderDailyHistory(nDays) {
            const days = lastNDates(nDays);
            const total = habits.length;
            let html = "";

            days.forEach(dateStr => {
                const list = completionsByDate[dateStr] || [];
                const count = list.length;
                const percent = total ? Math.round((count / total) * 100) : 0;
                const tags = list.length
                    ? list.map(h => `<span class="history-tag">${h.name || "Habit"}</span>`).join("")
                    : `<span class="history-meta">No habits completed</span>`;

                html += `
                <div class="history-item">
                    <div>
                        <div class="history-date">${formatDisplayDate(dateStr)}</div>
                        <div class="history-meta">
                            ${count} / ${total} habits done (${percent}%)
                        </div>
                    </div>
                    <div class="history-tags">
                        ${tags}
                    </div>
                </div>
                `;
            });

            historyList.innerHTML = html || "<div class='history-meta'>No history yet.</div>";
        }

        // åˆå§‹ï¼šThis Weekï¼ˆ7 å¤©ï¼‰
        renderDailyHistory(7);

        // period buttons
        const periodButtons = document.querySelectorAll(".view-btn[data-period]");
        periodButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                periodButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                const period = btn.dataset.period;
                let n = 7;
                if (period === "day") n = 1;
                else if (period === "week") n = 7;
                else if (period === "month") n = 30;
                renderDailyHistory(n);
            });
        });

        // ===== Calendar â†” List view åˆ‡æ› =====
        const historySection = document.getElementById("historySection");
        const calendarToggle = document.getElementById("toggleCalendarView");

        // é è¨­é¡¯ç¤ºï¼šsquare calendarï¼›list å…ˆè—èµ·ä¾†
        if (calendarGrid) {
            calendarGrid.classList.add("square");    // ä¸€é–‹å§‹å°±ç”¨ square layout
        }
        if (historySection) {
            historySection.style.display = "none";
        }
        if (dayDetailsBox) {
            dayDetailsBox.style.display = "block";
        }

        let isCalendarMode = true; // true = Calendar, false = List

        if (calendarToggle) {
            calendarToggle.textContent = "List view";   // Calendar ç‹€æ…‹ä¸‹çš„æŒ‰éˆ•æ–‡å­—

            calendarToggle.addEventListener("click", () => {
                isCalendarMode = !isCalendarMode;

                if (isCalendarMode) {
                    // é¡¯ç¤º Square Calendar
                    if (calendarGrid) {
                        calendarGrid.style.display = "grid";
                        calendarGrid.classList.add("square");
                    }
                    if (dayDetailsBox) {
                        dayDetailsBox.style.display = "block";
                    }
                    if (historySection) {
                        historySection.style.display = "none";
                    }
                    calendarToggle.textContent = "List view";
                } else {
                    // é¡¯ç¤º List viewï¼ˆåˆ‡éŽä¾†æ™‚è‡ªå‹•é¡¯ç¤ºæœ€è¿‘ 7 å¤©ï¼‰
                    if (calendarGrid) {
                        calendarGrid.style.display = "none";
                    }
                    if (dayDetailsBox) {
                        dayDetailsBox.style.display = "none";
                    }
                    if (historySection) {
                        historySection.style.display = "block";
                    }

                    // ðŸ” åˆ‡åˆ° list view æ™‚ï¼Œå¼·åˆ¶é¡¯ç¤ºã€ŒThis Weekã€ï¼ 7 å¤©
                    if (typeof renderDailyHistory === "function") {
                        renderDailyHistory(7);
                    }
                    const periodButtons = document.querySelectorAll(".view-btn[data-period]");
                    periodButtons.forEach(b => b.classList.remove("active"));
                    const weekBtn = document.querySelector('.view-btn[data-period="week"]');
                    if (weekBtn) weekBtn.classList.add("active");

                    calendarToggle.textContent = "Square calendar view";
                }
            });
        }

    } catch (err) {
        console.error("[analytics] error:", err);
        const calendarGrid = document.getElementById("calendarGrid");
        const historyList = document.getElementById("dailyHistoryList");
        if (calendarGrid) {
            calendarGrid.innerHTML = "<div class='history-meta'>Failed to load analytics.</div>";
        }
        if (historyList) {
            historyList.innerHTML = "<div class='history-meta'>Failed to load analytics.</div>";
        }
    }
});
</script>
{% endblock %}


