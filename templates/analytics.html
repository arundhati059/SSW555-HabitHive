{% extends "base_dashboard.html" %}
{% block content %}

<div class="analytics-container">

    <h2 class="page-title">ğŸ“Š Habit Analytics</h2>
    <p class="subtitle">Click any date to view all habits completed on that day.</p>

    <!-- ===================== 30-DAY HEATMAP ===================== -->
    <h3 class="section-title">ğŸ“… Last 30-Day Calendar</h3>

    <div class="calendar-grid">
        {% for d in last_30_days %}
            <div class="day-box 
                        {{ 'done' if d.done else '' }} 
                        {{ 'today' if d.date == today else '' }}"
                 data-date="{{ d.date }}"
                 onclick="showDayDetails('{{ d.date }}')"
                 title="{{ d.date }} â€” {{ 'Completed âœ”' if d.done else 'Not Completed' }}">
            </div>
        {% endfor %}
    </div>

    <!-- CLICKED DAY INFO -->
    <div id="dayDetailsBox" class="details-box hidden">
        <h4 id="detailsDate"></h4>
        <ul id="detailsList"></ul>
    </div>

    <hr>

    <!-- ===================== PER-HABIT STREAKS ===================== -->
    <h3 class="section-title">ğŸ”¥ Weekly Streaks by Habit</h3>

    {% for h in habits %}
        {% set stats = habit_stats[h.id] %}
        <div class="habit-card">

            <h4 class="habit-name">{{ h.name }}</h4>

            <p><strong>Weekly</strong></p>
            <p>ğŸ”¥ Current Streak: {{ stats.current }} days</p>
            <p>ğŸ† Longest Streak: {{ stats.longest }} days</p>
            <p>ğŸ“… This Week: {{ stats.weekly_count }}/7</p>

        </div>
    {% endfor %}

</div>
{% endblock %}

{% block scripts %}
<style>
.analytics-container { max-width: 900px; margin: 40px auto; }

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(15, 18px);
    gap: 6px;
    margin-bottom: 25px;
}
.day-box {
    width: 18px;
    height: 18px;
    background: #dadada;
    border-radius: 4px;
    cursor: pointer;
}
.day-box.done { background: #6a5af9; }
.day-box.today { border: 2px solid black; }

.details-box {
    padding: 15px;
    background: #fff;
    border-radius: 10px;
    border: 1px solid #ddd;
    max-width: 400px;
    margin-top: 20px;
}
.hidden { display: none; }

.habit-card {
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
</style>

<script>
// DATA FROM BACKEND
const HABITS = {{ habits|tojson }};
const STATS = {{ habit_stats|tojson }};
const COMPLETED = {{ completed_global|tojson }};

// Converts list of completed dates per habit into lookup
const completions_by_date = {};

Object.keys(STATS).forEach(hid => {
    STATS[hid].completed_dates.forEach(d => {
        if (!completions_by_date[d]) completions_by_date[d] = [];
        completions_by_date[d].push(hid);
    });
});

function showDayDetails(date) {
    const box = document.getElementById("dayDetailsBox");
    const detailsDate = document.getElementById("detailsDate");
    const ul = document.getElementById("detailsList");

    detailsDate.innerText = "ğŸ“… " + date;
    ul.innerHTML = "";

    if (!completions_by_date[date] || completions_by_date[date].length === 0) {
        ul.innerHTML = "<li>No habits completed</li>";
    } else {
        completions_by_date[date].forEach(hid => {
            const habit = HABITS.find(h => h.id === hid);
            if (habit) ul.innerHTML += `<li>${habit.name}</li>`;
        });
    }

    box.classList.remove("hidden");
}
</script>

{% endblock %}
