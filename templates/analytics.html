{% extends "base_dashboard.html" %}
{% block content %}

<div class="analytics-container">

{% block content %}
<div class="dashboard-main">
    <div class="analytics-page-content">
    <div class="analytics-container">
        <div class="analytics-header">
            <h2 class="analytics-title">
                <i class="fas fa-chart-line analytics-icon"></i>
                Habit Analytics
            </h2>
            <p class="analytics-subtitle">Track your progress, identify patterns, and optimize your habit-building journey with detailed insights.</p>
        </div>
        
        <!-- Time Period Selector -->
        <div class="time-selector">
            <div class="selector-buttons">
                <button class="time-btn active" data-period="week">This Week</button>
                <button class="time-btn" data-period="month">This Month</button>
                <button class="time-btn" data-period="quarter">3 Months</button>
                <button class="time-btn" data-period="year">This Year</button>
            </div>
        </div>
        
        <!-- Key Metrics -->
        <div class="metrics-overview">
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="metric-content">
                    <h3>Overall Success Rate</h3>
                    <div class="metric-value">87%</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        +5% from last week
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="metric-content">
                    <h3>Current Streak</h3>
                    <div class="metric-value">15 days</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        Personal best!
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="metric-content">
                    <h3>Active Habits</h3>
                    <div class="metric-value">8</div>
                    <div class="metric-change neutral">
                        <i class="fas fa-equals"></i>
                        Same as last week
                    </div>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="metric-content">
                    <h3>Average Completion Time</h3>
                    <div class="metric-value">8:30 AM</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        30 min earlier
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Completion History (Last 7 days, real data) -->
        <div class="history-section">
            <div class="section-header">
                <h3><i class="fas fa-list"></i> Daily Completion History</h3>
                <p class="analytics-subtitle">
                    See how many habits you completed each day (last 7 days).
                </p>
            </div>
            <div id="dailyHistoryList" class="history-list">
                <div class="history-empty">Loading your history...</div>
            </div>
        </div>
        
        <!-- Progress Chart -->
        <div class="chart-section">
            <div class="section-header">
                <h3><i class="fas fa-chart-area"></i> Progress Over Time</h3>
                <div class="chart-controls">
                    <select id="chartHabit" class="chart-selector">
                        <option value="all">All Habits</option>
                        <option value="exercise">Morning Exercise</option>
                        <option value="reading">Daily Reading</option>
                        <option value="water">Drink Water</option>
                        <option value="meditation">Meditation</option>
                    </select>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="progressChart" width="800" height="300"></canvas>
            </div>
        </div>
        
        <!-- Habit Performance -->
        <div class="habit-performance-section">
            <div class="section-header">
                <h3><i class="fas fa-trophy"></i> Habit Performance</h3>
            </div>
            <div class="performance-grid">
                <div class="habit-performance-card best">
                    <div class="performance-header">
                        <div class="habit-icon">
                            <i class="fas fa-dumbbell"></i>
                        </div>
                        <div class="habit-info">
                            <h4>Morning Exercise</h4>
                            <span class="performance-badge best">Best Performer</span>
                        </div>
                    </div>
                    <div class="performance-stats">
                        <div class="stat-row">
                            <span>Success Rate:</span>
                            <span class="stat-value">95%</span>
                        </div>
                        <div class="stat-row">
                            <span>Current Streak:</span>
                            <span class="stat-value">21 days</span>
                        </div>
                        <div class="stat-row">
                            <span>Best Time:</span>
                            <span class="stat-value">6:00 AM</span>
                        </div>
                    </div>
                    <div class="performance-chart">
                        <div class="mini-chart">
                            <div class="chart-bar" style="height: 20%"></div>
                            <div class="chart-bar" style="height: 40%"></div>
                            <div class="chart-bar" style="height: 60%"></div>
                            <div class="chart-bar" style="height: 80%"></div>
                            <div class="chart-bar" style="height: 95%"></div>
                            <div class="chart-bar" style="height: 90%"></div>
                            <div class="chart-bar" style="height: 100%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="habit-performance-card good">
                    <div class="performance-header">
                        <div class="habit-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="habit-info">
                            <h4>Daily Reading</h4>
                            <span class="performance-badge good">Good Progress</span>
                        </div>
                    </div>
                    <div class="performance-stats">
                        <div class="stat-row">
                            <span>Success Rate:</span>
                            <span class="stat-value">82%</span>
                        </div>
                        <div class="stat-row">
                            <span>Current Streak:</span>
                            <span class="stat-value">12 days</span>
                        </div>
                        <div class="stat-row">
                            <span>Best Time:</span>
                            <span class="stat-value">8:30 PM</span>
                        </div>
                    </div>
                    <div class="performance-chart">
                        <div class="mini-chart">
                            <div class="chart-bar" style="height: 60%"></div>
                            <div class="chart-bar" style="height: 70%"></div>
                            <div class="chart-bar" style="height: 85%"></div>
                            <div class="chart-bar" style="height: 75%"></div>
                            <div class="chart-bar" style="height: 90%"></div>
                            <div class="chart-bar" style="height: 80%"></div>
                            <div class="chart-bar" style="height: 85%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="habit-performance-card needs-attention">
                    <div class="performance-header">
                        <div class="habit-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                        <div class="habit-info">
                            <h4>Drink Water</h4>
                            <span class="performance-badge needs-attention">Needs Attention</span>
                        </div>
                    </div>
                    <div class="performance-stats">
                        <div class="stat-row">
                            <span>Success Rate:</span>
                            <span class="stat-value">64%</span>
                        </div>
                        <div class="stat-row">
                            <span>Current Streak:</span>
                            <span class="stat-value">3 days</span>
                        </div>
                        <div class="stat-row">
                            <span>Best Time:</span>
                            <span class="stat-value">10:00 AM</span>
                        </div>
                    </div>
                    <div class="performance-chart">
                        <div class="mini-chart">
                            <div class="chart-bar" style="height: 40%"></div>
                            <div class="chart-bar" style="height: 50%"></div>
                            <div class="chart-bar" style="height: 30%"></div>
                            <div class="chart-bar" style="height: 60%"></div>
                            <div class="chart-bar" style="height: 70%"></div>
                            <div class="chart-bar" style="height: 55%"></div>
                            <div class="chart-bar" style="height: 65%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Weekly Patterns -->
        <div class="patterns-section">
            <div class="section-header">
                <h3><i class="fas fa-calendar-week"></i> Weekly Patterns</h3>
            </div>
            <div class="patterns-grid">
                <!-- Day of Week Performance -->
                <div class="pattern-card">
                    <h4>Best Days of the Week</h4>
                    <div class="day-performance">
                        <div class="day-item best">
                            <span class="day-name">Monday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 92%"></div>
                            </div>
                            <span class="day-percent">92%</span>
                        </div>
                        <div class="day-item">
                            <span class="day-name">Tuesday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 88%"></div>
                            </div>
                            <span class="day-percent">88%</span>
                        </div>
                        <div class="day-item">
                            <span class="day-name">Wednesday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 85%"></div>
                            </div>
                            <span class="day-percent">85%</span>
                        </div>
                        <div class="day-item">
                            <span class="day-name">Thursday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 83%"></div>
                            </div>
                            <span class="day-percent">83%</span>
                        </div>
                        <div class="day-item">
                            <span class="day-name">Friday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 78%"></div>
                            </div>
                            <span class="day-percent">78%</span>
                        </div>
                        <div class="day-item worst">
                            <span class="day-name">Saturday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 65%"></div>
                            </div>
                            <span class="day-percent">65%</span>
                        </div>
                        <div class="day-item">
                            <span class="day-name">Sunday</span>
                            <div class="day-bar">
                                <div class="day-progress" style="width: 72%"></div>
                            </div>
                            <span class="day-percent">72%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Time of Day Performance -->
                <div class="pattern-card">
                    <h4>Peak Performance Times</h4>
                    <div class="time-performance">
                        <div class="time-slot">
                            <div class="time-label">Morning (6-12 PM)</div>
                            <div class="time-stats">
                                <div class="time-bar">
                                    <div class="time-progress morning" style="width: 89%"></div>
                                </div>
                                <span class="time-percent">89%</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-label">Afternoon (12-6 PM)</div>
                            <div class="time-stats">
                                <div class="time-bar">
                                    <div class="time-progress afternoon" style="width: 76%"></div>
                                </div>
                                <span class="time-percent">76%</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-label">Evening (6-10 PM)</div>
                            <div class="time-stats">
                                <div class="time-bar">
                                    <div class="time-progress evening" style="width: 82%"></div>
                                </div>
                                <span class="time-percent">82%</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-label">Night (10 PM-6 AM)</div>
                            <div class="time-stats">
                                <div class="time-bar">
                                    <div class="time-progress night" style="width: 45%"></div>
                                </div>
                                <span class="time-percent">45%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Insights & Recommendations -->
        <div class="insights-section">
            <div class="section-header">
                <h3><i class="fas fa-lightbulb"></i> Insights & Recommendations</h3>
            </div>
            <div class="insights-grid">
                <div class="insight-card tip">
                    <div class="insight-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="insight-content">
                        <h4>Optimal Timing</h4>
                        <p>You're 34% more likely to complete habits in the morning. Consider moving your water drinking habit to 7:00 AM.</p>
                    </div>
                </div>
                
                <div class="insight-card warning">
                    <div class="insight-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="insight-content">
                        <h4>Weekend Challenge</h4>
                        <p>Your completion rate drops 27% on weekends. Try setting weekend-specific reminders or adjusting your routine.</p>
                    </div>
                </div>
                
                <div class="insight-card success">
                    <div class="insight-icon">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="insight-content">
                        <h4>Streak Champion</h4>
                        <p>Your current 15-day streak is your personal best! You're building excellent consistency patterns.</p>
                    </div>
                </div>
                
                <div class="insight-card info">
                    <div class="insight-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="insight-content">
                        <h4>Growth Trend</h4>
                        <p>Your overall success rate has improved 12% this month. Keep up the great momentum!</p>
                    </div>
                </div>
    <h2 class="page-title">üìä Habit Analytics</h2>
    <p class="subtitle">Click any date to view all habits completed on that day.</p>

    <!-- ===================== 30-DAY HEATMAP ===================== -->
    <h3 class="section-title">üìÖ Last 30-Day Calendar</h3>

    <div class="calendar-grid">
        {% for d in last_30_days %}
            <div class="day-box 
                        {{ 'done' if d.done else '' }} 
                        {{ 'today' if d.date == today else '' }}"
                 data-date="{{ d.date }}"
                 onclick="showDayDetails('{{ d.date }}')"
                 title="{{ d.date }} ‚Äî {{ 'Completed ‚úî' if d.done else 'Not Completed' }}">
            </div>
        {% endfor %}
    </div>

    <!-- CLICKED DAY INFO -->
    <div id="dayDetailsBox" class="details-box hidden">
        <h4 id="detailsDate"></h4>
        <ul id="detailsList"></ul>
    </div>

    <hr>

    <!-- ===================== PER-HABIT STREAKS ===================== -->
    <h3 class="section-title">üî• Weekly Streaks by Habit</h3>

    {% for h in habits %}
        {% set stats = habit_stats[h.id] %}
        <div class="habit-card">

            <h4 class="habit-name">{{ h.name }}</h4>

            <p><strong>Weekly</strong></p>
            <p>üî• Current Streak: {{ stats.current }} days</p>
            <p>üèÜ Longest Streak: {{ stats.longest }} days</p>
            <p>üìÖ This Week: {{ stats.weekly_count }}/7</p>

        </div>
    {% endfor %}

</div>
{% endblock %}

{% block scripts %}
<script type="module">
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
import { listActiveHabits, mapProgressLast7, lastNDates } from "/static/js/dashboard-data.js";

const auth = window.firebaseAuth;
const historyListEl = document.getElementById("dailyHistoryList");

document.addEventListener('DOMContentLoaded', function() {
    // ÂàùÂßãÂåñ‰∏äÈù¢ÁöÑ chartÔºàÂÖàÁ∂≠ÊåÅ sample dataÔºâ
    initializeProgressChart();
    
    // ÊôÇÈñìÂçÄÈñìÊåâÈàï
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateChartData(this.getAttribute('data-period'));
            // ÁõÆÂâç history Âè™ÂÅö„ÄåÊúÄËøë 7 Â§©„ÄçÔºåÊâÄ‰ª•Êö´ÊôÇ‰∏çË∑ü period Á∂Å
        });
    });
    
    // chart habit selector
    document.getElementById('chartHabit').addEventListener('change', function() {
        updateChartData(
            document.querySelector('.time-btn.active').getAttribute('data-period'),
            this.value
        );
    });

    // ÂèñÂæóÁôªÂÖ•‰ΩøÁî®ËÄÖÔºåËºâÂÖ•ÊØèÊó•Ê≠∑Âè≤
    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadDailyHistory(user.uid);
        } else {
            renderHistoryEmpty("Please sign in to see your daily history.");
        }
    });
});

/* === Daily historyÔºàUser StoryÔºöhistory list of daily completionsÔºâ === */

async function loadDailyHistory(uid) {
    try {
        const [habits, last7Map] = await Promise.all([
            listActiveHabits(uid),
            mapProgressLast7(uid),
        ]);
        renderDailyHistory(habits, last7Map);
    } catch (e) {
        console.error("[analytics] history load error", e);
        renderHistoryEmpty("Failed to load history.");
    }
}

function renderHistoryEmpty(msg) {
    if (!historyListEl) return;
    historyListEl.innerHTML = `<div class="history-empty">${msg}</div>`;
}

function renderDailyHistory(habits, last7Map) {
    if (!historyListEl) return;

    const days = lastNDates(7); // [today, yesterday, ...]
    const habitNameById = {};
    habits.forEach(h => {
        habitNameById[h.id] = h.title || "Untitled habit";
    });

    // ÊåâÊó•ÊúüÊï¥ÁêÜÔºö{ dateKey: [habitName, ...] }
    const byDate = {};
    Object.entries(last7Map).forEach(([habitId, meta]) => {
        if (!meta.days) return;
        const name = habitNameById[habitId] || "Untitled habit";
        Object.keys(meta.days).forEach(dateKey => {
            if (!byDate[dateKey]) byDate[dateKey] = [];
            byDate[dateKey].push(name);
        });
    });

    const total = habits.length || 0;

    // ËÆìÊúÄËàäÂú®‰∏ä / ‰ªäÂ§©Âú®ÊúÄ‰∏ãÔºåÂèØÊîπÊàê‰∏ç reverse
    const itemsHtml = [...days].reverse().map(dateKey => {
        const completed = byDate[dateKey] || [];
        const count = completed.length;
        const percent = total ? Math.round((count / total) * 100) : 0;

        const dateObj = new Date(dateKey + "T00:00:00");
        const displayDate = dateObj.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            weekday: "short",
        });

        const habitBadges = completed.length
            ? completed.map(name => `<span class="history-tag">${name}</span>`).join("")
            : `<span class="history-meta">No habits completed</span>`;

        return `
        <div class="history-item">
            <div>
                <div class="history-date">${displayDate}</div>
                <div class="history-meta">${count} / ${total} habits done (${percent}%)</div>
            </div>
            <div class="history-tags">
                ${habitBadges}
            </div>
        </div>`;
    }).join("");

    historyListEl.innerHTML = itemsHtml;
}

/* === ÂéüÊú¨ÁöÑ chart Á®ãÂºèÁÖßÁî®ÔºàÊîæÂú®Âêå‰∏ÄÂÄã module Ë£°Ôºâ === */

function initializeProgressChart() {
    const canvas = document.getElementById('progressChart');
    const ctx = canvas.getContext('2d');
    
    // Sample data for the chart
    const chartData = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Completion Rate',
            data: [92, 88, 85, 83, 78, 65, 72],
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    };
    
    drawChart(ctx, chartData, canvas.width, canvas.height);
}
<style>
.analytics-container { max-width: 900px; margin: 40px auto; }

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(15, 18px);
    gap: 6px;
    margin-bottom: 25px;
}
.day-box {
    width: 18px;
    height: 18px;
    background: #dadada;
    border-radius: 4px;
    cursor: pointer;
}
.day-box.done { background: #6a5af9; }
.day-box.today { border: 2px solid black; }

.details-box {
    padding: 15px;
    background: #fff;
    border-radius: 10px;
    border: 1px solid #ddd;
    max-width: 400px;
    margin-top: 20px;
}
.hidden { display: none; }

.habit-card {
    border: 1px solid #eee;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 15px;
}
</style>

<script>
// DATA FROM BACKEND
const HABITS = {{ habits|tojson }};
const STATS = {{ habit_stats|tojson }};
const COMPLETED = {{ completed_global|tojson }};

// Converts list of completed dates per habit into lookup
const completions_by_date = {};

Object.keys(STATS).forEach(hid => {
    STATS[hid].completed_dates.forEach(d => {
        if (!completions_by_date[d]) completions_by_date[d] = [];
        completions_by_date[d].push(hid);
    });
});

function showDayDetails(date) {
    const box = document.getElementById("dayDetailsBox");
    const detailsDate = document.getElementById("detailsDate");
    const ul = document.getElementById("detailsList");

    detailsDate.innerText = "üìÖ " + date;
    ul.innerHTML = "";

    if (!completions_by_date[date] || completions_by_date[date].length === 0) {
        ul.innerHTML = "<li>No habits completed</li>";
    } else {
        completions_by_date[date].forEach(hid => {
            const habit = HABITS.find(h => h.id === hid);
            if (habit) ul.innerHTML += `<li>${habit.name}</li>`;
        });
    }

    box.classList.remove("hidden");
}
</script>

{% endblock %}
