{% extends "base_dashboard.html" %}

{% block title %}Dashboard - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
    <!-- My Goals Section -->
    <div class="dashboard-section mb-5">
        <div class="section-header d-flex align-items-center mb-4">
            <h3 class="section-title mb-0">🎯 My Goals</h3>
        </div>
        
        <div id="goalsContainer">
            <div class="loading-spinner text-center">
                <i class="fas fa-spinner fa-spin"></i> Loading your goals...
            </div>
        </div>
    </div>
  </div>
</div>

        <!-- My Habits Section -->
    <div class="dashboard-section">
        <div class="section-header d-flex align-items-center mb-4">
            <h3 class="section-title mb-0">✅ My Habits</h3>
        </div>

        <div id="habitsContainer">

            <!-- 🔁 視圖切換按鈕：List / Weekly / Monthly -->
            <div class="d-flex justify-content-end mb-3">
                <div class="btn-group btn-group-sm" id="habit-view-switch" role="group">
                    <button type="button" class="btn btn-outline-secondary active" data-view="list">
                        List
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-view="history">
                        Weekly
                    </button>
                    <button type="button" class="btn btn-outline-secondary" data-view="calendar">
                        Monthly
                    </button>
                </div>
            </div>

            <!-- 📋 List 視圖（目前你已有的：進度條 + 列表 + 新增表單） -->
            <div id="habit-view-list">
                <!-- 整體進度 -->
                <div id="progress-wrap" class="mb-3" style="display:none;">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span id="progress-text">Today: 0% completed</span>
                        <span id="progress-count">0 / 0</span>
                    </div>
                    <div class="progress">
                        <div id="progress-bar"
                             class="progress-bar"
                             role="progressbar"
                             style="width:0%;"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                        </div>
                    </div>
                </div>

                <!-- 沒有任何 habit 時的 empty state -->
                <div id="empty-state" class="empty-state text-muted" style="display:none;">
                    <p class="mb-2">No habits yet. Create your first habit to get started!</p>
                    <button type="button" id="btn-add-habit" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> + Add Habit
                    </button>
                </div>

                <!-- 習慣列表 -->
                <ul id="habit-list" class="list-group mt-3">
                    <!-- JS 會把 li 塞進來 -->
                </ul>

                <!-- 新增 Habit 表單（含「今天就算完成」）-->
                <form id="add-habit-form" class="mt-4">
                    <div class="mb-2">
                        <label for="habit-title" class="form-label">New habit</label>
                        <input type="text"
                               id="habit-title"
                               class="form-control"
                               placeholder="e.g. Drink water"
                               required>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input"
                               type="checkbox"
                               id="habit-mark-today"
                               checked>
                        <label class="form-check-label" for="habit-mark-today">
                            Mark today as done to start my streak
                        </label>
                    </div>

                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Habit
                    </button>
                </form>
            </div>

            <!-- 📜 Weekly 歷史視圖（User Story 1：Daily history list） -->
            <div id="habit-view-history" style="display:none;">
                <h5 class="mb-2">Weekly History (Last 7 days)</h5>
                <div id="history-list" class="list-group">
                    <!-- JS 會塞每日完成紀錄 -->
                </div>
            </div>

            <!-- 📅 Monthly Calendar 視圖（User Story 2：Calendar/Monthly/Daily） -->
            <div id="habit-view-calendar" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Monthly Calendar</h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="calendar-prev">&lt;</button>
                        <span id="calendar-label" class="mx-2"></span>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="calendar-next">&gt;</button>
                    </div>
                </div>

                <div id="calendar-grid" class="mb-2">
                    <!-- JS 會畫出每一天 -->
                </div>

                <div id="calendar-detail" class="mt-2 small text-muted">
                    <!-- 點某一天後顯示「Daily view」細節 -->
                </div>

                <small class="text-muted d-block mt-2">
                    Each day shows how many habits were completed. Click a day to see which habits you completed.
                </small>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🏠 Dashboard loaded - fetching goals...');
    loadUserGoals();

    // 讓「+ Add Habit」按鈕可以捲到新增表單（User Story 3 體驗加強）
    const addBtn = document.getElementById('btn-add-habit');
    if (addBtn) {
        addBtn.addEventListener('click', function () {
            const form = document.getElementById('add-habit-form');
            const titleInput = document.getElementById('habit-title');
            if (titleInput) titleInput.focus();
            if (form) form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
    }
});

async function loadUserGoals() {
    try {
        console.log('📊 Fetching goals from /get-goals...');
        const response = await fetch('/get-goals');
        const result = await response.json();
        
        console.log('📄 Goals response:', result);
        
        const container = document.getElementById('goalsContainer');
        
        if (result.success && result.goals && result.goals.length > 0) {
            console.log(`✅ Found ${result.goals.length} goals`);
            displayGoals(result.goals, container);
        } else {
            console.log('📭 No goals found');
            container.innerHTML = `
                <div class="empty-state text-muted">
                    No goals yet. Create your first goal to get started!
                </div>
            `;
        }
    } catch (error) {
        console.error('💥 Error loading goals:', error);
        document.getElementById('goalsContainer').innerHTML = `
            <div class="empty-state text-muted">
                No goals yet. Create your first goal to get started!
            </div>
        `;
    }
}

function displayGoals(goals, container) {
    const goalsHtml = goals.map(goal => {
        const progress = goal.targetValue > 0
            ? Math.round((goal.currentValue / goal.targetValue) * 100)
            : 0;
        const isCompleted = goal.status === 'Completed' || progress >= 100;
        
        const targetDate = new Date(goal.endDate || goal.targetDate);
        const today = new Date();
        const daysLeft = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        const formattedDate = targetDate.toLocaleDateString(
            'en-US',
            { month: 'numeric', day: 'numeric', year: 'numeric' }
        );
        
        return `
        <div class="goal-card ${isCompleted ? 'completed' : ''}">
            <div class="goal-card-header">
                <div class="goal-header-content">
                    <div class="goal-title-row">
                        <h3 class="goal-title">${goal.title}</h3>
                        ${isCompleted ? '<span class="completed-badge">Completed</span>' : ''}
                    </div>
                    <div class="goal-icon">
                        🎯
                    </div>
                </div>
                <p class="goal-description">${goal.description || ''}</p>
                ${goal.type ? `<span class="goal-category-badge">${goal.type}</span>` : ''}
            </div>
            
            <div class="goal-card-body">
                <div class="goal-progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Progress</span>
                        <span class="progress-value">${goal.currentValue} / ${goal.targetValue}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progress}%"></div>
                    </div>
                    <span class="progress-percentage">${progress}% complete</span>
                </div>
                
                <div class="goal-footer">
                    <div class="goal-date">
                        <span class="date-label">Target Date: ${formattedDate}</span>
                        <span class="days-left ${daysLeft < 0 ? 'overdue' : ''}">
                            ${daysLeft < 0 ? 'Overdue' : daysLeft + ' days left'}
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="goal-card-actions">
                ${isCompleted ? `
                    <button class="btn-goal-action btn-update"
                            onclick="updateProgress('${goal.id}', ${goal.currentValue}, ${goal.targetValue})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <button class="btn-goal-action btn-reopen" onclick="reopenGoal('${goal.id}')">
                        Reopen
                    </button>
                    <button class="btn-goal-action btn-delete" onclick="deleteGoal('${goal.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <button class="btn-goal-action btn-update"
                            onclick="updateProgress('${goal.id}', ${goal.currentValue}, ${goal.targetValue})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <button class="btn-goal-action btn-complete" onclick="markComplete('${goal.id}')">
                        Mark Complete
                    </button>
                    <button class="btn-goal-action btn-delete" onclick="deleteGoal('${goal.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `}
            </div>
        </div>
        `;
    }).join('');
    
    container.innerHTML = goalsHtml;
}

async function updateProgress(goalId, currentValue, targetValue) {
    console.log('📝 Updating progress for goal:', goalId);
    
    const newValue = prompt(
        `Update progress (current: ${currentValue}/${targetValue}):`,
        currentValue
    );
    
    if (newValue === null) return;
    
    const parsedValue = parseInt(newValue);
    if (isNaN(parsedValue) || parsedValue < 0) {
        alert('Please enter a valid number');
        return;
    }
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ currentValue: parsedValue })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Progress updated successfully');
            loadUserGoals();
        } else {
            console.error('❌ Failed to update progress:', result.error);
            alert('Failed to update progress: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error updating progress:', error);
        alert('Error updating progress. Please try again.');
    }
}

async function markComplete(goalId) {
    console.log('✅ Marking goal as complete:', goalId);
    
    if (!confirm('Mark this goal as complete?')) return;
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'Completed' })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal marked as complete');
            loadUserGoals();
        } else {
            console.error('❌ Failed to mark complete:', result.error);
            alert('Failed to mark as complete: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error marking complete:', error);
        alert('Error marking goal as complete. Please try again.');
    }
}

async function reopenGoal(goalId) {
    console.log('🔄 Reopening goal:', goalId);
    
    if (!confirm('Reopen this goal?')) return;
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: 'In Progress' })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal reopened');
            loadUserGoals();
        } else {
            console.error('❌ Failed to reopen goal:', result.error);
            alert('Failed to reopen goal: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error reopening goal:', error);
        alert('Error reopening goal. Please try again.');
    }
}

async function deleteGoal(goalId) {
    console.log('🗑️ Deleting goal:', goalId);
    
    if (!confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete-goal/${goalId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal deleted successfully');
            loadUserGoals();
        } else {
            console.error('❌ Failed to delete goal:', result.error);
            alert('Failed to delete goal: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error deleting goal:', error);
        alert('Error deleting goal. Please try again.');
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}

</script>

<!-- 把 Firestore habits 的 dashboard-page.js 載進來 -->
<script type="module" src="{{ url_for('static', filename='js/dashboard-page.js') }}"></script>
{% endblock %}
