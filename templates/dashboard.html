{% extends "base_dashboard.html" %}

{% block title %}Dashboard - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
    <!-- My Goals Section -->
    <div class="dashboard-section mb-5">
        <div class="section-header d-flex align-items-center mb-4">
            <h3 class="section-title mb-0">🎯 My Goals</h3>
        </div>
        
        <div id="goalsContainer">
            <div class="loading-spinner text-center">
                <i class="fas fa-spinner fa-spin"></i> Loading your goals...
            </div>
        </div>
    </div>

    <!-- My Habits Section -->
    <div class="dashboard-section mb-5">
        <div class="section-header d-flex align-items-center mb-4">
            <h3 class="section-title mb-0">🔥 My Habits</h3>
        </div>

        <div id="habitsContainer">
            <div class="loading-spinner text-center">
                <i class="fas fa-spinner fa-spin"></i> Loading habits...
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🏠 Dashboard loaded - fetching goals and habits...');
    loadUserGoals();
    loadHabits();
});

async function loadUserGoals() {
    try {
        console.log('📊 Fetching goals from /get-goals...');
        const response = await fetch('/get-goals');
        const result = await response.json();
        
        console.log('📄 Goals response:', result);
        
        const container = document.getElementById('goalsContainer');
        
        if (result.success && result.goals && result.goals.length > 0) {
            console.log(`✅ Found ${result.goals.length} goals`);
            displayGoals(result.goals, container);
        } else {
            console.log('📭 No goals found');
            container.innerHTML = `
                <div class="empty-state text-muted">
                    No goals yet. Create your first goal to get started!
                </div>
            `;
        }
    } catch (error) {
        console.error('💥 Error loading goals:', error);
        document.getElementById('goalsContainer').innerHTML = `
            <div class="empty-state text-muted">
                No goals yet. Create your first goal to get started!
            </div>
        `;
    }
}

function displayGoals(goals, container) {
    const goalsHtml = goals.map(goal => {
        // Calculate progress percentage
        const progress = goal.targetValue > 0 ? Math.round((goal.currentValue / goal.targetValue) * 100) : 0;
        const isCompleted = goal.status === 'Completed' || progress >= 100;
        
        // Calculate days left
        const targetDate = new Date(goal.endDate || goal.targetDate);
        const today = new Date();
        const daysLeft = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        // Format target date
        const formattedDate = targetDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
        
        return `
        <div class="goal-card ${isCompleted ? 'completed' : ''}">
            <div class="goal-card-header">
                <div class="goal-header-content">
                    <div class="goal-title-row">
                        <h3 class="goal-title">${goal.title}</h3>
                        ${isCompleted ? '<span class="completed-badge">Completed</span>' : ''}
                    </div>
                    <div class="goal-icon">
                        🎯
                    </div>
                </div>
                <p class="goal-description">${goal.description || ''}</p>
                ${goal.type ? `<span class="goal-category-badge">${goal.type}</span>` : ''}
            </div>
            
            <div class="goal-card-body">
                <div class="goal-progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Progress</span>
                        <span class="progress-value">${goal.currentValue} / ${goal.targetValue}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progress}%"></div>
                    </div>
                    <span class="progress-percentage">${progress}% complete</span>
                </div>
                
                <div class="goal-footer">
                    <div class="goal-date">
                        <span class="date-label">Target Date: ${formattedDate}</span>
                        <span class="days-left ${daysLeft < 0 ? 'overdue' : ''}">${daysLeft < 0 ? 'Overdue' : daysLeft + ' days left'}</span>
                    </div>
                </div>
            </div>
            
            <div class="goal-card-actions">
                ${isCompleted ? `
                    <button class="btn-goal-action btn-update" onclick="updateProgress('${goal.id}', ${goal.currentValue}, ${goal.targetValue})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <button class="btn-goal-action btn-reopen" onclick="reopenGoal('${goal.id}')">
                        Reopen
                    </button>
                    <button class="btn-goal-action btn-delete" onclick="deleteGoal('${goal.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <button class="btn-goal-action btn-update" onclick="updateProgress('${goal.id}', ${goal.currentValue}, ${goal.targetValue})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <button class="btn-goal-action btn-complete" onclick="markComplete('${goal.id}')">
                        Mark Complete
                    </button>
                    <button class="btn-goal-action btn-delete" onclick="deleteGoal('${goal.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `}
            </div>
        </div>
        `;
    }).join('');
    
    container.innerHTML = goalsHtml;
}

async function updateProgress(goalId, currentValue, targetValue) {
    console.log('📝 Updating progress for goal:', goalId);
    
    // Prompt user for new progress value
    const newValue = prompt(`Update progress (current: ${currentValue}/${targetValue}):`, currentValue);
    
    if (newValue === null) return; // User cancelled
    
    const parsedValue = parseInt(newValue);
    if (isNaN(parsedValue) || parsedValue < 0) {
        alert('Please enter a valid number');
        return;
    }
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentValue: parsedValue
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Progress updated successfully');
            // Reload goals to show updated progress
            loadUserGoals();
        } else {
            console.error('❌ Failed to update progress:', result.error);
            alert('Failed to update progress: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error updating progress:', error);
        alert('Error updating progress. Please try again.');
    }
}

async function markComplete(goalId) {
    console.log('🎯 Marking goal complete:', goalId);

    try {
        const res = await fetch(`/goal/${goalId}/complete`, {
            method: "POST"
        });

        const data = await res.json();

        if (data.success) {
            showSuccess(data.message || "Goal marked complete!");
            loadUserGoals();
        } else {
            alert(data.error || "Failed to mark goal complete");
        }
    } catch (err) {
        console.error("Goal complete error:", err);
        alert("Error marking goal complete");
    }
}




async function reopenGoal(goalId) {
    console.log('🔄 Reopening goal:', goalId);
    
    if (!confirm('Reopen this goal?')) {
        return;
    }
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'In Progress'
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal reopened');
            // Reload goals to show updated state
            loadUserGoals();
        } else {
            console.error('❌ Failed to reopen goal:', result.error);
            alert('Failed to reopen goal: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error reopening goal:', error);
        alert('Error reopening goal. Please try again.');
    }
}

async function deleteGoal(goalId) {
    console.log('🗑️ Deleting goal:', goalId);
    
    if (!confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete-goal/${goalId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal deleted successfully');
            // Reload goals to remove deleted goal
            loadUserGoals();
        } else {
            console.error('❌ Failed to delete goal:', result.error);
            alert('Failed to delete goal: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error deleting goal:', error);
        alert('Error deleting goal. Please try again.');
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}



// ---------------------- LOAD HABITS ---------------------- //
async function loadHabits() {
    try {
        const res = await fetch("/api/habits");
        const data = await res.json();

        const container = document.getElementById("habitsContainer");

        if (!data.success || data.habits.length === 0) {
            container.innerHTML = `
                <div class="empty-state text-muted">No habits yet. Create one!</div>
            `;
            return;
        }

        container.innerHTML = data.habits.map(habit => habitCard(habit)).join("");

        // After rendering cards, load progress for each habit
        data.habits.forEach(h => loadHabitWeeklyProgress(h.id));

    } catch (e) {
        console.error("Habit load error:", e);
    }
}

// ---------------------- HABIT CARD UI (GOAL-LIKE) ---------------------- //
function habitCard(habit) {
    return `
    <div class="goal-card" id="habit-${habit.id}">
        <div class="goal-card-header">
            <div class="goal-header-content">
                <div class="goal-title-row">
                    <h3 class="goal-title">${habit.name}</h3>
                </div>
                <div class="goal-icon">🔥</div>
            </div>

            <p class="goal-description">${habit.description || "No description provided."}</p>

            <span class="goal-category-badge">${habit.frequency.toUpperCase()}</span>
        </div>

        <div class="goal-card-body">

            <div class="goal-progress-section">
                <div class="progress-header">
                    <span class="progress-label">Weekly Progress</span>
                    <span id="progress-count-${habit.id}" class="progress-value">0/7</span>
                </div>

                <div class="progress-bar-container">
                    <div id="progress-bar-${habit.id}" class="progress-bar-fill" style="width:0%"></div>
                </div>

                <span id="progress-percent-${habit.id}" class="progress-percentage">0% complete</span>
            </div>

            <div class="goal-footer">
                <div class="goal-date">
                    <span class="date-label">Streak:</span>
                    <span id="streak-${habit.id}" class="days-left">🔥 0 days</span>
                </div>
            </div>
        </div>

        <div class="goal-card-actions">
            <button class="btn-goal-action btn-complete" onclick="markHabitDone('${habit.id}')">
                Mark Complete
            </button>
        </div>
    </div>
    `;
}

// ---------------------- MARK HABIT DONE ---------------------- //
// ---------------------- MARK HABIT DONE  ---------------------- //
async function markHabitDone(habitId) {
    console.log('➡️ Marking habit as done:', habitId);

    // Confirmation popup (same as goal)
    if (!confirm("Mark this habit as complete for today?")) {
        return;
    }

    try {
        const res = await fetch(`/habit/${habitId}/complete`, {
            method: "POST"
        });

        const data = await res.json();
        console.log("Habit complete result:", data);

        // Already completed today
        if (data.message === "Already marked today") {
            alert("You have already completed this habit today ✔️");
            return;
        }

        // Success message
        if (data.success) {
            alert("Habit marked as completed for today! 🎉");
            loadHabitWeeklyProgress(habitId); // refresh streak + heatmap
        }

    } catch (e) {
        console.error("❌ Habit mark error:", e);
        alert("Something went wrong while marking habit complete.");
    }
}


// ---------------------- LOAD WEEKLY PROGRESS ---------------------- //
async function loadHabitWeeklyProgress(habitId) {
    try {
        const res = await fetch(`/habit/${habitId}/weekly-progress`);
        const data = await res.json();

        if (!data.success) return;

        const weeklyCount = data.weekly_count;
        const percentage = Math.round((weeklyCount / 7) * 100);

        // Update Progress Bar
        document.getElementById(`progress-count-${habitId}`).innerText = `${weeklyCount}/7`;
        document.getElementById(`progress-bar-${habitId}`).style.width = `${percentage}%`;
        document.getElementById(`progress-percent-${habitId}`).innerText = `${percentage}% complete`;

        // Update Streaks
        document.getElementById(`streak-${habitId}`).innerHTML =
            `🔥 Current: ${data.streak_current} days — 🏆 Longest: ${data.streak_longest} days`;

    } catch (e) {
        console.error("Weekly progress error:", e);
    }
}

// ---------------------- SUCCESS POPUP ---------------------- //
function showSuccess(msg) {
    const div = document.createElement("div");
    div.className = "success-toast";
    div.innerText = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2500);
}


</script>
{% endblock %}
