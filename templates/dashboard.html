{% extends "base_dashboard.html" %}

{% block title %}Dashboard - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
    <!-- My Goals Section -->
    <div class="dashboard-section mb-5">
        <div class="section-header d-flex align-items-center mb-4">
            <h3 class="section-title mb-0">🎯 My Goals</h3>
        </div>
        
        <div id="goalsContainer">
            <div class="loading-spinner text-center">
                <i class="fas fa-spinner fa-spin"></i> Loading your goals...
            </div>
        </div>
    </div>

      <!-- My Habits Section -->
  <div class="dashboard-section">
    <div class="section-header d-flex align-items-center mb-4">
      <h3 class="section-title mb-0">My Habits</h3>
    </div>

    <!-- Habit progress summary -->
    <div id="habitProgressSummary" class="goal-progress-section mb-3" style="display:none;">
      <div class="progress-header" style="align-items: center;">
        <div>
          <span class="progress-label">Today</span>
          <span id="habitProgressValue" class="progress-value"></span>
        </div>
        <button type="button"
                class="habit-reset-btn"
                onclick="showHabitResetWarning()">
          Reset today
        </button>
      </div>

      <!-- Inline warning -->
      <div id="habitResetWarning" class="habit-reset-warning" style="display:none;">
        <div class="habit-reset-warning-text">
          This will set all habits to incomplete for today.
        </div>
        <div class="habit-reset-warning-actions">
          <button type="button"
                  class="habit-reset-confirm-btn"
                  onclick="resetHabitsToday()">
            Yes, reset
          </button>
          <button type="button"
                  class="habit-reset-cancel-btn"
                  onclick="hideHabitResetWarning()">
            Cancel
          </button>
        </div>
      </div>

      <div class="progress-bar-container">
        <div id="habitProgressFill" class="progress-bar-fill" style="width: 0%"></div>
      </div>
      <span id="habitProgressPercent" class="progress-percentage"></span>
    </div>

    <div id="habitsContainer">
      <!-- existing empty-state or cards go here -->
    </div>
  </div>
</div>

<!-- Habit edit modal -->
<div id="habitEditOverlay" class="modal-overlay" style="display:none;">
  <div class="modal-card">
    <div class="modal-header">
      <h3 class="modal-title">Edit Habit</h3>
      <p class="modal-subtitle">
        Update your habit details for
        <span id="habitEditNameLabel" class="fw-bold"></span>.
      </p>
    </div>

    <div class="modal-body">
      <!-- Name -->
      <div class="form-group">
        <label for="habitEditName" class="form-label">Habit Name</label>
        <input type="text"
               id="habitEditName"
               class="form-input"
               placeholder="e.g. Morning Jog" />
      </div>

      <!-- Purpose -->
      <div class="form-group">
        <label for="habitEditPurpose" class="form-label">Purpose</label>
        <textarea id="habitEditPurpose"
                  class="form-textarea"
                  rows="2"
                  placeholder="Why are you doing this habit?"></textarea>
      </div>

      <!-- Frequency -->
      <div class="form-group">
        <label for="habitEditFrequency" class="form-label">Frequency</label>
        <select id="habitEditFrequency" class="form-select">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <!-- Custom frequency -->
      <div id="habitEditCustomFrequencyGroup" class="form-row hidden">
        <div class="form-group half">
          <label for="habitEditCustomValue" class="form-label">Every</label>
          <input type="number"
                 id="habitEditCustomValue"
                 class="form-input"
                 min="1" />
        </div>
        <div class="form-group half">
          <label for="habitEditCustomUnit" class="form-label">Unit</label>
          <select id="habitEditCustomUnit" class="form-select">
            <option value="days">Days</option>
            <option value="weeks">Weeks</option>
            <option value="months">Months</option>
          </select>
        </div>
      </div>

      <!-- Preferred time -->
      <div class="form-group">
        <label for="habitEditReminderTime" class="form-label">Preferred Complete Time</label>

        <div style="display:flex; gap:8px; align-items:center;">
          <input type="time"
                id="habitEditReminderTime"
                class="form-input"
                style="flex:1;" />
          <button type="button"
                  class="btn-secondary"
                  style="padding:6px 10px; font-size:0.8rem;"
                  onclick="clearHabitReminder()">
            Remove
          </button>
        </div>

        <div class="text-muted-small">
          Clear the time to remove this reminder.
        </div>
      </div>

      <!-- Visibility -->
      <div class="form-group row-between">
        <div>
          <label class="form-label mb-1">Visibility</label>
          <div class="text-muted-small">
            Private habits are only visible to you.
          </div>
        </div>
        <label class="switch">
          <input type="checkbox" id="habitEditIsPrivate" />
          <span class="slider"></span>
        </label>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button"
              class="btn-secondary"
              onclick="closeHabitEditOverlay()">
        Cancel
      </button>
      <button type="button"
              class="btn-primary"
              onclick="confirmEditHabit()">
        Save Changes
      </button>
    </div>
  </div>
</div>



{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🏠 Dashboard loaded - fetching goals and habits...');
    loadUserGoals();
    loadHabits();
});

let habitMap = {};


async function loadUserGoals() {
    try {
        console.log('📊 Fetching goals from /get-goals...');
        const response = await fetch('/get-goals');
        const result = await response.json();
        
        console.log('📄 Goals response:', result);
        
        const container = document.getElementById('goalsContainer');
        
        if (result.success && result.goals && result.goals.length > 0) {
            console.log(`✅ Found ${result.goals.length} goals`);
            displayGoals(result.goals, container);
        } else {
            console.log('📭 No goals found');
            container.innerHTML = `
                <div class="empty-state text-muted">
                    No goals yet. Create your first goal to get started!
                </div>
            `;
        }
    } catch (error) {
        console.error('💥 Error loading goals:', error);
        document.getElementById('goalsContainer').innerHTML = `
            <div class="empty-state text-muted">
                No goals yet. Create your first goal to get started!
            </div>
        `;
    }
}
// async function loadUserHabits() {
//     const container = document.getElementById("habitsContainer");
//     if (!container) {
//         console.warn("habitsContainer not found");
//         return;
//     }

//     // show loading state
//     container.innerHTML = `
//         <div class="loading-spinner text-center">
//             <i class="fas fa-spinner fa-spin"></i> Loading your habits...
//         </div>
//     `;

//     try {
//         const response = await fetch("/api/habits");
//         const result = await response.json();
//         console.log("Habits response:", result);

//         if (!result.success) {
//             container.innerHTML = `
//                 <div class="text-danger">Failed to load habits: ${result.error || "Unknown error"}</div>
//             `;
//             return;
//         }

//         const habits = result.habits || [];

//         if (!habits.length) {
//             container.innerHTML = `
//                 <div class="empty-state text-muted">
//                     No Habits yet. Create your first habit to get started!
//                 </div>
//             `;
//             return;
//         }
//         // compute summary progress
//         const total = habits.length;
//         const completed = habits.filter(h => h.isCompletedToday).length;
//         const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

//         const summary = document.getElementById('habitProgressSummary');
//         const valueSpan = document.getElementById('habitProgressValue');
//         const fill = document.getElementById('habitProgressFill');
//         const percentSpan = document.getElementById('habitProgressPercent');

//         if (summary && valueSpan && fill && percentSpan) {
//         summary.style.display = 'block';
//         valueSpan.textContent = `${completed} / ${total} habits completed`;
//         fill.style.width = `${pct}%`;
//         percentSpan.textContent = `${pct}% complete`;
//         }
        

//         // build habit cards
//        const itemsHtml = habits.map(habit => `
//         <div class="habit-card mb-3">
//             <div class="habit-header">
//             <div class="habit-info">
//                 <div class="habit-title-row">
//                 <h3 class="habit-name">${habit.name || "Untitled habit"}</h3>
//                 <span class="habit-badge ${habit.isPrivate ? 'private' : 'public'}">
//                     ${habit.isPrivate
//                     ? '<i class="fas fa-lock"></i> Private'
//                     : '<i class="fas fa-globe-americas"></i> Public'}
//                 </span>
//                 ${habit.isCompletedToday ? `<span class="completed-badge">Completed</span>` : ''}
//                 </div>

//                 <div class="habit-meta">
//                 <span class="habit-frequency">
//                     ${(habit.frequency || "daily").toUpperCase()}
//                 </span>
//                 </div>

//                 <p class="habit-description">
//                 ${habit.description || ""}
//                 </p>

//                 ${habit.reminderTime ? `
//                 <div class="habit-reminder">
//                     <i class="fas fa-bell"></i>
//                     Preferred time ${habit.reminderTime}
//                 </div>
//                 ` : ""}
//             </div>

//             <div class="habit-actions-right"></div>
//             </div>

//         <div class="goal-card-actions" id="habit-actions-${habit.id}">
//             <button class="btn-goal-action"
//                     onclick="markHabitDone('${habit.id}')">
//                 Mark complete
//             </button>

//             <button class="btn-goal-action btn-update"
//                     onclick="openHabitEditOverlay('${habit.id}', ${JSON
//                         .stringify(habit)
//                         .replace(/"/g, '&quot;')})">
//                 <i class="fas fa-edit"></i> Edit Habit
//             </button>

//             <button class="btn-goal-action btn-delete"
//                     onclick="openHabitDeleteOverlay('${habit.id}', '${(habit.name || "")
//                         .replace(/'/g, "\\'")
//                         .replace(/"/g, '&quot;')}')">
//                 <i class="fas fa-trash"></i> Delete
//             </button>
//         </div>

//         </div>
//         `).join("");


//         container.innerHTML = itemsHtml;












//         container.innerHTML = itemsHtml;
//     } catch (err) {
//         console.error("Error loading habits:", err);
//         container.innerHTML = `
//             <div class="text-danger">
//                 Error loading habits. Please try again later.
//             </div>
//         `;
//     }
// }

async function deleteHabit(habitId) {
    if (!confirm('Delete this habit? This action cannot be undone.')) {
        return;
    }

    try {
        const res = await fetch(`/api/habits/${habitId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
            console.error('Failed to delete habit:', data.error);
            alert('Failed to delete habit: ' + (data.error || 'Unknown error'));
            return;
        }

        // Refresh habits list
        await loadUserHabits();
    } catch (err) {
        console.error('Error deleting habit:', err);
        alert('Error deleting habit. Please try again.');
    }
}

async function editHabit(habitId, habit) {
    // Very simple UX: prompts; you can replace with a modal later
    const newName = prompt('Edit habit name:', habit.name || '');
    if (newName === null) return;

    const newDescription = prompt('Edit description:', habit.description || '');
    if (newDescription === null) return;

    const newFrequency = prompt(
        'Edit frequency (e.g. daily, weekly):',
        habit.frequency || 'daily'
    );
    if (newFrequency === null) return;

    const payload = {
        name: newName.trim(),
        description: newDescription.trim(),
        frequency: newFrequency.trim().toLowerCase(),
    };

    try {
        const res = await fetch(`/api/habits/${habitId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok || !data.success) {
            console.error('Failed to update habit:', data.error);
            alert('Failed to update habit: ' + (data.error || 'Unknown error'));
            return;
        }

        // Refresh habits list
        await loadUserHabits();
    } catch (err) {
        console.error('Error updating habit:', err);
        alert('Error updating habit. Please try again.');
    }
}
let habitToDeleteId = null;

function openHabitDeleteOverlay(habitId, habitName) {
    console.log('openHabitDeleteOverlay called with', habitId, habitName);
    habitToDeleteId = habitId;

    const nameSpan = document.getElementById('habitDeleteName');
    if (nameSpan) {
        nameSpan.textContent = habitName || 'this habit';
    }

    const overlay = document.getElementById('habitDeleteOverlay');
    if (overlay) {
        overlay.style.display = 'flex';
    }
}

function closeHabitDeleteOverlay() {
    console.log('closeHabitDeleteOverlay');
    const overlay = document.getElementById('habitDeleteOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    habitToDeleteId = null;
}

async function confirmDeleteHabit() {
    console.log('confirmDeleteHabit, habitToDeleteId =', habitToDeleteId);
    if (!habitToDeleteId) {
        closeHabitDeleteOverlay();
        return;
    }

    try {
        const res = await fetch(`/api/habits/${habitToDeleteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        const data = await res.json().catch(() => ({}));
        console.log('DELETE /api/habits response:', res.status, data);

        if (!res.ok || !data.success) {
            console.error('Failed to delete habit:', data.error);
            alert('Failed to delete habit: ' + (data.error || 'Unknown error'));
        } else {
            await loadUserHabits();
        }
    } catch (err) {
        console.error('Error deleting habit:', err);
        alert('Error deleting habit. Please try again.');
    } finally {
        closeHabitDeleteOverlay();
    }
}

let habitToEditId = null;
function openHabitEditOverlay(habitId, habit) {
  console.log('openHabitEditOverlay', habitId, habit);
  habitToEditId = habitId;
  habit = habit || {};

  const nameLabel = document.getElementById('habitEditNameLabel');
  const nameInput = document.getElementById('habitEditName');
  const purposeInput = document.getElementById('habitEditPurpose');
  const freqSelect = document.getElementById('habitEditFrequency');
  const customGroup = document.getElementById('habitEditCustomFrequencyGroup');
  const customValue = document.getElementById('habitEditCustomValue');
  const customUnit = document.getElementById('habitEditCustomUnit');
  const remTime = document.getElementById('habitEditReminderTime');
  const isPrivateToggle = document.getElementById('habitEditIsPrivate');

  if (nameLabel) nameLabel.textContent = habit.name || 'this habit';
  if (nameInput) nameInput.value = habit.name || '';
  if (purposeInput) purposeInput.value = habit.description || '';

  const freq = (habit.frequency || 'daily').toLowerCase();
  if (freqSelect) {
    freqSelect.value = ['daily','weekly','monthly','custom'].includes(freq) ? freq : 'daily';
  }

  if (customValue) customValue.value = habit.customFrequencyValue || '';
  if (customUnit) customUnit.value = habit.customFrequencyUnit || 'days';
  if (customGroup && freqSelect) {
    customGroup.style.display = freqSelect.value === 'custom' ? 'flex' : 'none';
  }

  if (remTime) {
    remTime.value = habit.reminderTime || '';
  }

  if (isPrivateToggle) {
    isPrivateToggle.checked = !!habit.isPrivate;
  }

  const overlay = document.getElementById('habitEditOverlay');
  if (overlay) {
    overlay.style.display = 'flex';
  }
}


function closeHabitEditOverlay() {
  console.log('closeHabitEditOverlay');
  const overlay = document.getElementById('habitEditOverlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
  habitToEditId = null;
}

// toggle custom frequency UI
document.addEventListener('DOMContentLoaded', () => {
  const freqSelect = document.getElementById('habitEditFrequency');
  const customGroup = document.getElementById('habitEditCustomFrequencyGroup');
  const remEnabled = document.getElementById('habitEditReminderEnabled');
  const remTimeGroup = document.getElementById('habitEditReminderTimeGroup');

  if (freqSelect && customGroup) {
    freqSelect.addEventListener('change', () => {
      customGroup.style.display = freqSelect.value === 'custom' ? 'flex' : 'none';
    });
  }

  if (remEnabled && remTimeGroup) {
    remEnabled.addEventListener('change', () => {
      remTimeGroup.style.display = remEnabled.checked ? 'block' : 'none';
    });
  }
});

function clearHabitReminder() {
  const remTime = document.getElementById('habitEditReminderTime');
  if (remTime) {
    remTime.value = '';
  }
}

async function confirmEditHabit() {
  console.log('confirmEditHabit, id =', habitToEditId);
  if (!habitToEditId) {
    closeHabitEditOverlay();
    return;
  }

  const nameInput = document.getElementById('habitEditName');
  const purposeInput = document.getElementById('habitEditPurpose');
  const freqSelect = document.getElementById('habitEditFrequency');
  const customValue = document.getElementById('habitEditCustomValue');
  const customUnit = document.getElementById('habitEditCustomUnit');
  const remTime = document.getElementById('habitEditReminderTime');
  const isPrivateToggle = document.getElementById('habitEditIsPrivate');

  const name = (nameInput?.value || '').trim();
  const description = (purposeInput?.value || '').trim();
  const frequency = (freqSelect?.value || 'daily').toLowerCase();

  if (!name) {
    alert('Habit name is required');
    return;
  }

  const reminderTime = remTime ? remTime.value : '';
  const payload = {
    name,
    description,
    frequency,
    reminderEnabled: !!reminderTime,   // enabled if a time is set
    reminderTime: reminderTime || null,
    isPrivate: !!(isPrivateToggle && isPrivateToggle.checked),
  };

  if (frequency === 'custom') {
    payload.customFrequencyValue = customValue ? Number(customValue.value || 0) : null;
    payload.customFrequencyUnit = customUnit ? (customUnit.value || 'days') : 'days';
  } else {
    payload.customFrequencyValue = null;
    payload.customFrequencyUnit = null;
  }

  try {
    const res = await fetch(`/api/habits/${habitToEditId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(() => ({}));
    console.log('PUT /api/habits response:', res.status, data);

    if (!res.ok || !data.success) {
      console.error('Failed to update habit:', data.error);
      alert('Failed to update habit: ' + (data.error || 'Unknown error'));
      return;
    }

    await loadUserHabits();
  } catch (err) {
    console.error('Error updating habit:', err);
    alert('Error updating habit. Please try again.');
  } finally {
    closeHabitEditOverlay();
  }
}

async function updateHabitProgress(habitId, currentValue, targetValue) {
  console.log('📝 Updating progress for habit:', habitId);

  const newValueStr = prompt(
    `Update habit progress (current: ${currentValue}/${targetValue || '?'}):`,
    currentValue
  );
  if (newValueStr === null) return;

  const newValue = parseInt(newValueStr, 10);
  if (isNaN(newValue) || newValue < 0) {
    alert('Please enter a valid number');
    return;
  }

  try {
    const res = await fetch(`/update-habit/${habitId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ currentValue: newValue }),
    });

    const result = await res.json().catch(() => ({}));
    if (res.ok && result.success) {
      await loadUserHabits();  // refresh habit cards
    } else {
      alert('Failed to update habit: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Error updating habit:', err);
    alert('Error updating habit. Please try again.');
  }
}

async function toggleHabitComplete(habitId, wasCompleted) {
  console.log('🔁 Toggling habit completion:', habitId, 'wasCompleted =', wasCompleted);

  try {
    const res = await fetch(`/complete-habit/${habitId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
    });

    const result = await res.json().catch(() => ({}));
    if (res.ok && result.success) {
      await loadUserHabits();  // updates button text, badge, and summary bar
    } else {
      alert('Failed to toggle habit: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Error toggling habit:', err);
    alert('Error toggling habit. Please try again.');
  }
}
async function resetHabitsToday() {
  try {
    const res = await fetch('/reset-habits-today', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
    });

    const result = await res.json().catch(() => ({}));

    if (res.ok && result.success) {
      hideHabitResetWarning();       // hide inline warning
      await loadUserHabits();        // refresh badges + summary bar
    } else {
      alert('Failed to reset habits: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Error resetting habits:', err);
    alert('Error resetting habits. Please try again.');
  }
}

function showHabitResetWarning() {
  const warning = document.getElementById('habitResetWarning');
  if (warning) warning.style.display = 'flex';
}

function hideHabitResetWarning() {
  const warning = document.getElementById('habitResetWarning');
  if (warning) warning.style.display = 'none';
}


function displayGoals(goals, container) {
    const goalsHtml = goals.map(goal => {
        // Calculate progress percentage
        const progress = goal.targetValue > 0 ? Math.round((goal.currentValue / goal.targetValue) * 100) : 0;
        const isCompleted = goal.status === 'Completed' || progress >= 100;
        
        // Calculate days left
        const targetDate = new Date(goal.endDate || goal.targetDate);
        const today = new Date();
        const daysLeft = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
        
        // Format target date
        const formattedDate = targetDate.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric', year: 'numeric' });
        
        return `
        <div class="goal-card ${isCompleted ? 'completed' : ''}">
            <div class="goal-card-header">
                <div class="goal-header-content">
                    <div class="goal-title-row">
                        <h3 class="goal-title">${goal.title}</h3>
                        ${isCompleted ? '<span class="completed-badge">Completed</span>' : ''}
                    </div>
                    <div class="goal-icon">
                        🎯
                    </div>
                </div>
                <p class="goal-description">${goal.description || ''}</p>
                ${goal.type ? `<span class="goal-category-badge">${goal.type}</span>` : ''}
            </div>
            
            <div class="goal-card-body">
                <div class="goal-progress-section">
                    <div class="progress-header">
                        <span class="progress-label">Progress</span>
                        <span class="progress-value">${goal.currentValue} / ${goal.targetValue}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${progress}%"></div>
                    </div>
                    <span class="progress-percentage">${progress}% complete</span>
                </div>
                
                <div class="goal-footer">
                    <div class="goal-date">
                        <span class="date-label">Target Date: ${formattedDate}</span>
                        <span class="days-left ${daysLeft < 0 ? 'overdue' : ''}">${daysLeft < 0 ? 'Overdue' : daysLeft + ' days left'}</span>
                    </div>
                </div>
            </div>
            
            <div class="goal-card-actions">
                ${isCompleted ? `
                    <button class="btn-goal-action btn-update" onclick="updateProgress('${goal.id}', ${goal.currentValue}, ${goal.targetValue})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <button class="btn-goal-action btn-reopen" onclick="reopenGoal('${goal.id}')">
                        Reopen
                    </button>
                    <button class="btn-goal-action btn-delete" onclick="deleteGoal('${goal.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                ` : `
                    <button class="btn-goal-action btn-update" onclick="updateProgress('${goal.id}', ${goal.currentValue}, ${goal.targetValue})">
                        <i class="fas fa-plus"></i> Update Progress
                    </button>
                    <button class="btn-goal-action btn-complete" onclick="markComplete('${goal.id}', ${goal.targetValue})">
                        Mark Complete
                    </button>
                    <button class="btn-goal-action btn-delete" onclick="deleteGoal('${goal.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                `}
            </div>
        </div>
        `;
    }).join('');
    
    container.innerHTML = goalsHtml;
}

async function updateProgress(goalId, currentValue, targetValue) {
    console.log('📝 Updating progress for goal:', goalId);
    
    // Prompt user for new progress value
    const newValue = prompt(`Update progress (current: ${currentValue}/${targetValue}):`, currentValue);
    
    if (newValue === null) return; // User cancelled
    
    const parsedValue = parseInt(newValue);
    if (isNaN(parsedValue) || parsedValue < 0) {
        alert('Please enter a valid number');
        return;
    }
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentValue: parsedValue
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Progress updated successfully');
            // Reload goals to show updated progress
            loadUserGoals();
        } else {
            console.error('❌ Failed to update progress:', result.error);
            alert('Failed to update progress: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error updating progress:', error);
        alert('Error updating progress. Please try again.');
    }
}

async function markComplete(goalId, targetValue) {
    console.log('🎯 Marking goal complete:', goalId);

    if (!confirm('Mark this goal as complete? This will set progress to maximum value.')) {
        return;
    }

    try {
        // First update the currentValue to targetValue, then mark as complete
        const updateRes = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentValue: targetValue,
                status: 'Completed'
            })
        });

        const data = await updateRes.json();

        if (data.success) {
            showSuccess("Goal marked complete with maximum progress!");
            loadUserGoals();
        } else {
            alert(data.error || "Failed to mark goal complete");
        }
    } catch (err) {
        console.error("Goal complete error:", err);
        alert("Error marking goal complete");
    }
}

function loadWeeklyProgress(habitId) {
    fetch(`/habit/${habitId}/weekly-progress`)
        .then(res => res.json())
        .then(data => {
            if (!data.success) return;

            const bar = document.querySelector(`#bar-${habitId}`);
            const freq = Number(document.querySelector(`#freq-${habitId}`).value);

            const percentage = Math.min((data.weekly_count / freq) * 100, 100);
            bar.style.width = percentage + "%";
        });
}



async function reopenGoal(goalId) {
    console.log('🔄 Reopening goal:', goalId);
    
    if (!confirm('Reopen this goal? This will reset the progress to zero.')) {
        return;
    }
    
    try {
        const response = await fetch(`/update-goal/${goalId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: 'In Progress',
                currentValue: 0
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal reopened');
            // Reload goals to show updated state
            loadUserGoals();
        } else {
            console.error('❌ Failed to reopen goal:', result.error);
            alert('Failed to reopen goal: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error reopening goal:', error);
        alert('Error reopening goal. Please try again.');
    }
}

async function deleteGoal(goalId) {
    console.log('🗑️ Deleting goal:', goalId);
    
    if (!confirm('Are you sure you want to delete this goal? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/delete-goal/${goalId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            console.log('✅ Goal deleted successfully');
            // Reload goals to remove deleted goal
            loadUserGoals();
        } else {
            console.error('❌ Failed to delete goal:', result.error);
            alert('Failed to delete goal: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('💥 Error deleting goal:', error);
        alert('Error deleting goal. Please try again.');
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString();
}



// ---------------------- LOAD HABITS ---------------------- //
async function loadHabits() {
    try {
        console.log('🔄 Loading habits...');
        const res = await fetch("/api/habits");
        console.log('📡 Habits fetch response status:', res.status);
        const data = await res.json();
        console.log('📊 Habits data received:', data);

        const container = document.getElementById("habitsContainer");

        if (!data.success || data.habits.length === 0) {
            console.log('📭 No habits found');
            container.innerHTML = `
                <div class="empty-state text-muted">No habits yet. Create one!</div>
            `;
            return;
        }

        console.log(`✅ Found ${data.habits.length} habits`);
        container.innerHTML = data.habits.map(habit => habitCard(habit)).join("");

        // After rendering cards, load progress for each habit
        data.habits.forEach(h => {
            console.log('🔄 Loading progress for habit:', h.id, h.name);
            loadHabitWeeklyProgress(h.id);
        });

    } catch (e) {
        console.error("Habit load error:", e);
    }
}

// ---------------------- HABIT CARD UI (GOAL-LIKE) ---------------------- //
function habitCard(habit) {
    // This will be updated by loadHabitWeeklyProgress with actual completion status
    const isCompleted = false; // Initial state, will be updated
    console.log('CARD DEBUG', habit.id, habit.name, habit.isPrivate);  // <- add this

    
    return `
    <div class="goal-card ${isCompleted ? 'completed' : ''}" id="habit-${habit.id}">
        <div class="goal-card-header">
            <div class="goal-header-content">
                <div class="goal-title-row">
                    <h3 class="goal-title">${habit.name}</h3>
                    <span class="habit-badge ${habit.isPrivate ? 'private' : 'public'}">
                        ${habit.isPrivate ? 'Private' : 'Public'}
                    </span>
                    <span id="completed-badge-${habit.id}" class="completed-badge" style="display: none;">Completed</span>
                </div>
                <div class="goal-icon">🔥</div>
            </div>

            <p class="goal-description">${habit.description || "No description provided."}</p>

            <span class="goal-category-badge">${habit.frequency.toUpperCase()}</span>

            ${habit.reminderTime ? `
              <div class="habit-reminder">
                <i class="fas fa-bell"></i>
                Preferred time ${habit.reminderTime}
              </div>
            ` : ``}
        </div>

        <div class="goal-card-body">
            <div class="goal-progress-section">
                <div class="progress-header">
                    <span class="progress-label">Weekly Progress</span>
                    <span id="progress-count-${habit.id}" class="progress-value">0/7</span>
                </div>

                <div class="progress-bar-container">
                    <div id="progress-bar-${habit.id}" class="progress-bar-fill" style="width:0%"></div>
                </div>

                <span id="progress-percent-${habit.id}" class="progress-percentage">0% complete</span>
            </div>

            <div class="goal-footer">
                <div class="streak-info">
                    <span id="streak-${habit.id}" class="streak-display">🔥 Current: 0 days 🏆</span>
                </div>
            </div>
        </div>

        <div class="goal-card-actions" id="habit-actions-${habit.id}">
            <button class="btn-goal-action"
                    onclick="markHabitDone('${habit.id}')">
                Mark complete
            </button>

            <button class="btn-goal-action btn-update"
                    onclick="openHabitEditOverlay('${habit.id}', ${JSON
                        .stringify(habit)
                        .replace(/"/g, '&quot;')})">
                <i class="fas fa-edit"></i> Edit Habit
            </button>

            <button class="btn-goal-action btn-delete"
                    onclick="openHabitDeleteOverlay('${habit.id}', '${(habit.name || '')
                        .replace(/'/g, '\\\'')
                        .replace(/"/g, '&quot;')}')">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>

    </div>
    `;
}


// ---------------------- MARK HABIT DONE  ---------------------- //
async function markHabitDone(habitId) {
    console.log('➡️ Marking habit as done:', habitId);
    console.log('📱 Function called successfully');

    // No confirmation needed - should work like goals

    try {
        const res = await fetch(`/habit/${habitId}/complete`, {
            method: "POST"
        });

        console.log('🌐 Response status:', res.status);
        
        // Check for authentication errors
        if (res.status === 401) {
            alert('Please log in to mark habits complete');
            window.location.href = '/login';
            return;
        }
        
        const data = await res.json();
        console.log("Habit complete result:", data);

        // Handle success - reload to show completed state
        if (data.success) {
            console.log("✅ Habit completion processed successfully");
            // Immediately update the UI to show completed state
            const habitCard = document.getElementById(`habit-${habitId}`);
            const completedBadge = document.getElementById(`completed-badge-${habitId}`);
            const actionsContainer = document.getElementById(`habit-actions-${habitId}`);
            
            // Add completed class
            if (habitCard) habitCard.classList.add('completed');
            if (completedBadge) completedBadge.style.display = 'inline-block';
            
            // Update progress to 7/7 immediately
            const progressCount = document.getElementById(`progress-count-${habitId}`);
            const progressBar = document.getElementById(`progress-bar-${habitId}`);
            const progressPercent = document.getElementById(`progress-percent-${habitId}`);
            
            if (progressCount) progressCount.innerText = '7/7';
            if (progressBar) progressBar.style.width = '100%';
            if (progressPercent) progressPercent.innerText = '100% complete';
            
            // Update streak if returned
            if (data.newStreak) {
                const streakDisplay = document.getElementById(`streak-${habitId}`);
                if (streakDisplay) streakDisplay.innerHTML = `🔥 Current: ${data.newStreak} days 🏆`;
            }
            
            // Then load the full progress data to refresh buttons
            loadHabitWeeklyProgress(habitId);
            
            // Update the top progress bar
            updateHabitProgressBar();
        } else {
            console.error('❌ Mark habit failed:', data);
        }

    } catch (e) {
        console.error("❌ Habit mark error:", e);
        alert("Something went wrong while marking habit complete: " + e.message);
    }
}


// ---------------------- LOAD WEEKLY PROGRESS ---------------------- //
async function loadHabitWeeklyProgress(habitId) {
    try {
        const res = await fetch(`/habit/${habitId}/weekly-progress`);
        const data = await res.json();

        if (!data.success) return;

        const weeklyCount = data.weekly_count;
        const percentage = Math.round((weeklyCount / 7) * 100);
        const completedToday = data.completed_today || false;
        const habitStatus = data.status || 'In Progress';
        
        console.log(`📊 Habit ${habitId} progress data:`, {
            weeklyCount,
            percentage,
            completedToday,
            habitStatus,
            streak_current: data.streak_current
        });

        // Update Progress Bar
        document.getElementById(`progress-count-${habitId}`).innerText = `${weeklyCount}/7`;
        document.getElementById(`progress-bar-${habitId}`).style.width = `${percentage}%`;
        document.getElementById(`progress-percent-${habitId}`).innerText = `${percentage}% complete`;

        // Update Streaks
        document.getElementById(`streak-${habitId}`).innerHTML =
            `🔥 Current: ${data.streak_current} days 🏆`;

        // Update completion state
        const habitCard = document.getElementById(`habit-${habitId}`);
        const completedBadge = document.getElementById(`completed-badge-${habitId}`);
        const actionsContainer = document.getElementById(`habit-actions-${habitId}`);
        
        const habitData = habitMap[habitId] || {};
        const habitJson = JSON.stringify(habitData).replace(/"/g, '&quot;');


        if (completedToday) {
            // Show completed state
            habitCard.classList.add('completed');
            completedBadge.style.display = 'inline-block';
            
            // Show completed buttons
            // inside the completedToday branch:
            // completedToday branch
            actionsContainer.innerHTML = `
              <button class="btn-goal-action btn-update"
                      onclick="updateHabitStreak('${habitId}', ${data.streakcurrent})">
                  <i class="fas fa-edit"></i> Update Streak
              </button>
              <button class="btn-goal-action btn-reopen"
                      onclick="reopenHabit('${habitId}')">
                  Reopen Habit
              </button>
              <button class="btn-goal-action btn-update"
                      onclick="openHabitEditOverlay('${habitId}', ${habitJson})">
                  <i class="fas fa-edit"></i> Edit Habit
              </button>
              <button class="btn-goal-action btn-delete"
                      onclick="deleteHabit('${habitId}', 'habit')">
                  <i class="fas fa-trash"></i>
              </button>
            `;


        } else {
            // Show incomplete state
            habitCard.classList.remove('completed');
            completedBadge.style.display = 'none';
            
            // Show incomplete buttons
            actionsContainer.innerHTML = `
              <button class="btn-goal-action btn-update"
                      onclick="updateHabitStreak('${habitId}', ${data.streakcurrent})">
                  <i class="fas fa-edit"></i> Update Streak
              </button>
              <button class="btn-goal-action btn-complete"
                      onclick="markHabitDone('${habitId}')">
                  Mark Complete
              </button>
              <button class="btn-goal-action btn-update"
                      onclick="openHabitEditOverlay('${habitId}', ${habitJson})">
                  <i class="fas fa-edit"></i> Edit Habit
              </button>
              <button class="btn-goal-action btn-delete"
                      onclick="deleteHabit('${habitId}', 'habit')">
                  <i class="fas fa-trash"></i>
              </button>
            `;


        }

    } catch (e) {
        console.error("Weekly progress error:", e);
    }
}

// ---------------------- UPDATE HABIT STREAK ---------------------- //
async function updateHabitStreak(habitId, currentStreak) {
    console.log('✏️ Updating streak for habit:', habitId, 'current streak:', currentStreak);
    
    // Prompt user for new streak value
    const newStreak = prompt(`Update habit streak (current: ${currentStreak}):`, currentStreak);
    
    if (newStreak === null) return; // User cancelled
    
    const parsedStreak = parseInt(newStreak);
    if (isNaN(parsedStreak) || parsedStreak < 0) {
        alert('Please enter a valid number (0 or greater)');
        return;
    }
    
    try {
        const response = await fetch(`/update-habit-streak/${habitId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentStreak: parsedStreak
            })
        });
        
        console.log('🌐 Update response status:', response.status);
        
        // Check for authentication errors
        if (response.status === 401) {
            alert('Please log in to update habits');
            window.location.href = '/login';
            return;
        }
        
        const result = await response.json();
        console.log('📊 Update result:', result);
        
        if (response.ok && result.success) {
            console.log('✅ Habit streak updated successfully');
            // Update the streak display for this specific habit
            document.getElementById(`streak-${habitId}`).innerHTML = 
                `🔥 Current: ${parsedStreak} days 🏆`;
            // Also refresh the weekly progress to update progress bar
            loadHabitWeeklyProgress(habitId);
            
            // Update the top progress bar
            updateHabitProgressBar();
        } else {
            console.error('❌ Failed to update habit streak:', result.error);
            alert('Failed to update streak: ' + (result.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error updating habit:', error);
    }
}

// ---------------------- REOPEN HABIT ---------------------- //
async function reopenHabit(habitId) {
    console.log('🔄 Reopening habit:', habitId);
    
    try {
        const response = await fetch(`/habit/${habitId}/reopen`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        console.log('🌐 Reopen response status:', response.status);
        
        // Check for authentication errors
        if (response.status === 401) {
            alert('Please log in to reopen habits');
            window.location.href = '/login';
            return;
        }
        
        const result = await response.json();
        console.log('📊 Reopen result:', result);
        
        if (response.ok && result.success) {
            console.log('✅ Habit reopened successfully');
            
            // Immediately update the UI to show reopened state
            const habitCard = document.getElementById(`habit-${habitId}`);
            const completedBadge = document.getElementById(`completed-badge-${habitId}`);
            
            // Remove completed class
            if (habitCard) habitCard.classList.remove('completed');
            if (completedBadge) completedBadge.style.display = 'none';
            
            // Reset progress to 0/7 immediately
            const progressCount = document.getElementById(`progress-count-${habitId}`);
            const progressBar = document.getElementById(`progress-bar-${habitId}`);
            const progressPercent = document.getElementById(`progress-percent-${habitId}`);
            
            if (progressCount) progressCount.innerText = '0/7';
            if (progressBar) progressBar.style.width = '0%';
            if (progressPercent) progressPercent.innerText = '0% complete';
            
            // Reset streak to 0
            if (result.newStreak !== undefined) {
                const streakDisplay = document.getElementById(`streak-${habitId}`);
                if (streakDisplay) streakDisplay.innerHTML = `🔥 Current: ${result.newStreak} days 🏆`;
            }
            
            // Then load the full progress data to refresh buttons
            loadHabitWeeklyProgress(habitId);
            
            // Update the top progress bar
            updateHabitProgressBar();
        } else {
            console.error('❌ Failed to reopen habit:', result.error);
        }
        
    } catch (error) {
        console.error('Error reopening habit:', error);
    }
}

// ---------------------- DELETE HABIT ---------------------- //
async function deleteHabit(habitId, habitName) {
    console.log('🗑️ Deleting habit:', habitId);
    
    // Confirmation dialog
    if (!confirm(`Are you sure you want to delete "${habitName}"? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/habits/${habitId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Habit deleted successfully! 🗑️');
            loadHabits(); // Reload habits to reflect the deletion
        } else {
            alert('Failed to delete habit: ' + (result.error || 'Unknown error'));
        }
        
    } catch (error) {
        console.error('Error deleting habit:', error);
        alert('Failed to delete habit. Please try again.');
    }
}

// ---------------------- SUCCESS POPUP ---------------------- //
function showSuccess(msg) {
    const div = document.createElement("div");
    div.className = "success-toast";
    div.innerText = msg;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 2500);
}

// ---------------------- UPDATE HABIT PROGRESS BAR ---------------------- //
async function updateHabitProgressBar() {
    try {
        const res = await fetch("/api/habits");
        const data = await res.json();
        
        if (!data.success || !data.habits) return;
        
        const habits = data.habits;

        // build a map: id -> habit
        habitMap = {};
        habits.forEach(h => {
          habitMap[h.id] = h;
        });

        // existing rendering line
        container.innerHTML = habits.map(habit => habitCard(habit)).join("");

        const total = habits.length;
        const completed = habits.filter(h => h.status === 'Completed').length;
        const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

        const summary = document.getElementById('habitProgressSummary');
        const valueSpan = document.getElementById('habitProgressValue');
        const fill = document.getElementById('habitProgressFill');
        const percentSpan = document.getElementById('habitProgressPercent');

        if (summary && valueSpan && fill && percentSpan) {
            summary.style.display = 'block';
            valueSpan.textContent = `${completed} / ${total} habits completed`;
            fill.style.width = `${pct}%`;
            percentSpan.textContent = `${pct}% complete`;
        }
    } catch (e) {
        console.error("Error updating habit progress bar:", e);
    }
}

// ---------------------- LOAD HABITS ---------------------- //
async function loadHabits() {
  try {
    console.log('🔄 Loading habits...');
    const res = await fetch("/api/habits");
    console.log('📡 Habits fetch response status:', res.status);
    const data = await res.json();
    console.log('📊 Habits data received:', data);

    const container = document.getElementById("habitsContainer");

    if (!data.success || !data.habits || data.habits.length === 0) {
      console.log('📭 No habits found');
      container.innerHTML = `
        <div class="empty-state text-muted">No habits yet. Create one!</div>
      `;
      const summary = document.getElementById('habitProgressSummary');
      if (summary) summary.style.display = 'none';
      return;
    }

    const habits = data.habits;

    // 🔹 build id -> habit map for the edit modal
    habitMap = {};
    habits.forEach(h => {
      habitMap[h.id] = h;
    });

    // --- Daily summary for top progress bar ---
    const total = habits.length;
    const completed = habits.filter(h => h.status === 'Completed').length;
    const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

    const summary = document.getElementById('habitProgressSummary');
    const valueSpan = document.getElementById('habitProgressValue');
    const fill = document.getElementById('habitProgressFill');
    const percentSpan = document.getElementById('habitProgressPercent');

    if (summary && valueSpan && fill && percentSpan) {
      summary.style.display = 'block';
      valueSpan.textContent = `${completed} / ${total} habits completed`;
      fill.style.width = `${pct}%`;
      percentSpan.textContent = `${pct}% complete`;
    }

    // --- Render cards using existing habitCard layout ---
    container.innerHTML = habits.map(habit => habitCard(habit)).join("");

    // After rendering cards, load weekly progress for each habit
    habits.forEach(h => loadHabitWeeklyProgress(h.id));
  } catch (e) {
    console.error("Habit load error:", e);
  }
}


// ---------- Daily completion toggle (top progress bar) ----------
async function toggleHabitComplete(habitId, wasCompleted) {
  console.log('🔁 Toggling habit completion:', habitId, 'wasCompleted =', wasCompleted);

  try {
    const res = await fetch(`/complete-habit/${habitId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
    });

    const result = await res.json().catch(() => ({}));
    if (res.ok && result.success) {
      await loadHabits();  // refresh cards + summary bar
    } else {
      alert('Failed to toggle habit: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Error toggling habit:', err);
    alert('Error toggling habit. Please try again.');
  }
}

function showHabitResetWarning() {
  const warning = document.getElementById('habitResetWarning');
  if (warning) warning.style.display = 'flex';
}

function hideHabitResetWarning() {
  const warning = document.getElementById('habitResetWarning');
  if (warning) warning.style.display = 'none';
}

async function resetHabitsToday() {
  console.log('🔄 Resetting all habits for today...');
  try {
    const res = await fetch('/reset-habits-today', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
    });

    const result = await res.json().catch(() => ({}));
    if (res.ok && result.success) {
      hideHabitResetWarning();
      await loadHabits();
    } else {
      alert('Failed to reset habits: ' + (result.error || 'Unknown error'));
    }
  } catch (err) {
    console.error('Error resetting habits:', err);
    alert('Error resetting habits. Please try again.');
  }
}


function openHabitEditOverlay(habitId, habit) {
  console.log('openHabitEditOverlay', habitId, habit);
  habitToEditId = habitId;
  habit = habit || {};

  const nameLabel = document.getElementById('habitEditNameLabel');
  const nameInput = document.getElementById('habitEditName');
  const purposeInput = document.getElementById('habitEditPurpose');
  const freqSelect = document.getElementById('habitEditFrequency');
  const customGroup = document.getElementById('habitEditCustomFrequencyGroup');
  const customValue = document.getElementById('habitEditCustomValue');
  const customUnit = document.getElementById('habitEditCustomUnit');
  const remTime = document.getElementById('habitEditReminderTime');
  const isPrivateToggle = document.getElementById('habitEditIsPrivate');

  if (nameLabel) nameLabel.textContent = habit.name || 'this habit';
  if (nameInput) nameInput.value = habit.name || '';
  if (purposeInput) purposeInput.value = habit.description || '';

  const freq = (habit.frequency || 'daily').toLowerCase();
  if (freqSelect) {
    freqSelect.value = ['daily','weekly','monthly','custom'].includes(freq) ? freq : 'daily';
  }

  if (customValue) customValue.value = habit.customFrequencyValue || '';
  if (customUnit) customUnit.value = habit.customFrequencyUnit || 'days';
  if (customGroup && freqSelect) {
    customGroup.style.display = freqSelect.value === 'custom' ? 'flex' : 'none';
  }

  if (remTime) {
    remTime.value = habit.reminderTime || '';
  }

  if (isPrivateToggle) {
    isPrivateToggle.checked = !!habit.isPrivate;
  }

  const overlay = document.getElementById('habitEditOverlay');
  if (overlay) {
    overlay.style.display = 'flex';
  }
}

function closeHabitEditOverlay() {
  const overlay = document.getElementById('habitEditOverlay');
  if (overlay) {
    overlay.style.display = 'none';
  }
  habitToEditId = null;
}

// toggle custom frequency UI inside modal
document.addEventListener('DOMContentLoaded', () => {
  const freqSelect = document.getElementById('habitEditFrequency');
  const customGroup = document.getElementById('habitEditCustomFrequencyGroup');

  if (freqSelect && customGroup) {
    freqSelect.addEventListener('change', () => {
      customGroup.style.display = freqSelect.value === 'custom' ? 'flex' : 'none';
    });
  }
});

async function confirmEditHabit() {
  console.log('confirmEditHabit, id =', habitToEditId);
  if (!habitToEditId) {
    closeHabitEditOverlay();
    return;
  }

  const nameInput = document.getElementById('habitEditName');
  const purposeInput = document.getElementById('habitEditPurpose');
  const freqSelect = document.getElementById('habitEditFrequency');
  const customValue = document.getElementById('habitEditCustomValue');
  const customUnit = document.getElementById('habitEditCustomUnit');
  const remTime = document.getElementById('habitEditReminderTime');
  const isPrivateToggle = document.getElementById('habitEditIsPrivate');

  const name = (nameInput?.value || '').trim();
  const description = (purposeInput?.value || '').trim();
  const frequency = (freqSelect?.value || 'daily').toLowerCase();

  if (!name) {
    alert('Habit name is required');
    return;
  }

  const reminderTime = remTime ? remTime.value : '';
  const payload = {
    name,
    description,
    frequency,
    reminderEnabled: !!reminderTime,   // enabled if a time is set
    reminderTime: reminderTime || null,
    isPrivate: !!(isPrivateToggle && isPrivateToggle.checked),
  };

  if (frequency === 'custom') {
    payload.customFrequencyValue = customValue ? Number(customValue.value || 0) : null;
    payload.customFrequencyUnit = customUnit ? (customUnit.value || 'days') : 'days';
  } else {
    payload.customFrequencyValue = null;
    payload.customFrequencyUnit = null;
  }

  try {
    const res = await fetch(`/api/habits/${habitToEditId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(() => ({}));
    console.log('PUT /api/habits response:', res.status, data);

    if (!res.ok || !data.success) {
      console.error('Failed to update habit:', data.error);
      alert('Failed to update habit: ' + (data.error || 'Unknown error'));
      return;
    }

    await loadHabits();
  } catch (err) {
    console.error('Error updating habit:', err);
    alert('Error updating habit. Please try again.');
  } finally {
    closeHabitEditOverlay();
  }
}





</script>
{% endblock %}
