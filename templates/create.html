{% extends "base_dashboard.html" %}
{% block title %}Create Habit - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
  <div class="container" style="max-width: 800px">
    <h1 class="mb-3">Create a New Habit</h1>

    <div class="card shadow-sm">
      <div class="card-body">
        <form id="createHabitForm">
          <!-- Name -->
          <div class="mb-3">
            <label class="form-label">Habit Name</label>
            <input type="text" class="form-control" id="habitName" name="name" placeholder="Drink water" required>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <textarea class="form-control" id="habitDescription" name="description" rows="2"
                      placeholder="Describe your habit…"></textarea>
          </div>

          <!-- Category + Frequency -->
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Category</label>
              <select class="form-select" id="habitCategory" name="category">
                <option value="general">General</option>
                <option value="health">Health</option>
                <option value="fitness">Fitness</option>
                <option value="study">Study</option>
                <option value="work">Work</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Frequency</label>
              <select class="form-select" id="habitFrequency" name="frequency">
                <option value="daily" selected>Daily</option>
                <option value="weekly">Weekly</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
          </div>

          <!-- Reminder -->
          <div class="mb-3 form-check">
            <input class="form-check-input" type="checkbox" id="reminderEnabled" name="reminderEnabled">
            <label class="form-check-label" for="reminderEnabled">
              Enable reminder
            </label>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label class="form-label">Reminder Time</label>
              <input type="time" class="form-control" id="reminderTime" name="reminderTime">
            </div>
            <div class="col-md-6">
              <label class="form-label">Reminder Days (optional)</label>
              <input type="text" class="form-control" id="reminderDays" name="reminderDays"
                     placeholder="e.g. Mon, Wed, Fri">
            </div>
          </div>

          <div id="createHabitError" class="alert alert-danger py-2" style="display:none;"></div>
          <div id="createHabitSuccess" class="alert alert-success py-2" style="display:none;"></div>

          <button type="submit" id="createHabitBtn" class="btn btn-success">
            <i class="fas fa-save me-1"></i>Create Habit
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const form   = document.getElementById('createHabitForm');
  const btn    = document.getElementById('createHabitBtn');
  const errBox = document.getElementById('createHabitError');
  const okBox  = document.getElementById('createHabitSuccess');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errBox.style.display = 'none';
    okBox.style.display  = 'none';

    const payload = {
      name: document.getElementById('habitName').value.trim(),
      description: document.getElementById('habitDescription').value.trim(),
      category: document.getElementById('habitCategory').value,
      frequency: document.getElementById('habitFrequency').value,
      reminderEnabled: document.getElementById('reminderEnabled').checked,
      reminderTime: document.getElementById('reminderTime').value || null,
      reminderDays: document.getElementById('reminderDays').value.trim() || null
    };

    if (!payload.name) {
      errBox.textContent = 'Habit name is required.';
      errBox.style.display = 'block';
      return;
    }

    try {
      btn.disabled = true;

      const res = await fetch("{{ url_for('habits_api') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });

      const data = await res.json();

      if (!res.ok || data.error) {
        throw new Error(data.error || 'Failed to create habit');
      }

      okBox.textContent = 'Habit created successfully! Redirecting to dashboard…';
      okBox.style.display = 'block';

      // Redirect to dashboard so the new habit appears in the list
      setTimeout(() => {
        window.location.href = "{{ url_for('dashboard') }}";
      }, 700);
    } catch (err) {
      console.error(err);
      errBox.textContent = 'Failed to create habit. Please try again.';
      errBox.style.display = 'block';
    } finally {
      btn.disabled = false;
    }
  });
});
</script>
{% endblock %}
