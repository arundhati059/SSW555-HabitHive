{% extends "base_dashboard.html" %}

{% block title %}Create - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
  <div class="create-page-content">
    <div class="page-header">
      <h1>Create New Goals & Habits</h1>
      <p>Build positive routines and set meaningful objectives</p>
    </div>

    <div class="create-grid">
      <!-- Left: Create New Habit -->
      <div class="create-card habit-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="title-icon">‚ú®</span>
            Create New Habit
          </h2>
        </div>
        <div class="card-content">
          <form id="createHabitForm" class="create-form"
                onsubmit="event.preventDefault(); handleCreateHabit();">
            <div id="habitErrorMessage" class="error-message" style="display:none;"></div>

            <div class="form-field">
              <label for="habitName" class="field-label">Habit Name *</label>
              <input type="text" id="habitName" name="habitName" class="field-input"
                     placeholder="e.g., Morning Meditation" required>
            </div>

            <div class="form-field">
              <label for="habitCategory" class="field-label">Category *</label>
              <select id="habitCategory" name="habitCategory" class="field-select" required>
                <option value="">Select a category</option>
                <option value="Health">Health</option>
                <option value="Fitness">Fitness</option>
                <option value="Study">Study</option>
                <option value="Work">Work</option>
                <option value="General">General</option>
              </select>
            </div>

            <div class="form-field">
              <label for="habitCustomCategory" class="field-label">Or Add Custom Category</label>
              <input type="text" id="habitCustomCategory" name="habitCustomCategory" class="field-input"
                     placeholder="Enter custom category">
            </div>

            <div class="form-field">
              <label for="habitFrequency" class="field-label">Frequency *</label>
              <select id="habitFrequency" name="habitFrequency" class="field-select" required>
                <option value="">Select frequency</option>
                <option value="Daily">Daily</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
              </select>
            </div>

            <div class="form-field">
              <label for="habitDifficulty" class="field-label">Difficulty</label>
              <select id="habitDifficulty" name="habitDifficulty" class="field-select">
                <option value="Easy">Easy</option>
                <option value="Medium" selected>Medium</option>
                <option value="Hard">Hard</option>
              </select>
            </div>

            <div class="form-field">
              <label class="field-label">Reminders</label>
              <div class="reminder-section">
                <button type="button" class="add-reminder-btn" onclick="addReminder()">
                  <i class="fas fa-plus"></i> Add Reminder
                </button>
                <div id="remindersList"></div>
              </div>
            </div>

            <button type="submit" class="submit-btn">
              <i class="fas fa-plus btn-icon"></i>
              Create Habit
            </button>
          </form>
        </div>
      </div>

      <!-- Right: Create Custom Goal -->
      <div class="create-card goal-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="title-icon">üéØ</span>
            Create Custom Goal
          </h2>
        </div>
        <div class="card-content">
          <form id="createGoalForm" class="create-form"
                onsubmit="event.preventDefault(); handleCreateGoal();">
            <div id="errorMessage" class="error-message" style="display:none;"></div>

            <div class="form-field">
              <label for="goalTitle" class="field-label">Goal Title *</label>
              <input type="text" id="goalTitle" name="goalTitle" class="field-input"
                     placeholder="e.g., Run a Marathon" required>
            </div>

            <div class="form-field">
              <label for="description" class="field-label">Description</label>
              <textarea id="description" name="description" class="field-textarea"
                        placeholder="Describe your goal..." rows="3"></textarea>
            </div>

            <div class="form-field">
              <label for="goalType" class="field-label">Goal Type *</label>
              <select id="goalType" name="goalType" class="field-select" required>
                <option value="">Select a type</option>
                <option value="Fitness">üí™ Fitness</option>
                <option value="Financial">üí∞ Financial</option>
                <option value="Learning">üìö Learning</option>
                <option value="Career">üöÄ Career</option>
                <option value="Personal">üåü Personal</option>
                <option value="Health">üè• Health</option>
                <option value="Relationship">‚ù§Ô∏è Relationship</option>
                <option value="Other">üéØ Other</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-field half">
                <label for="targetValue" class="field-label">Target Value</label>
                <input type="number" id="targetValue" name="targetValue" class="field-input"
                       placeholder="e.g., 42" min="0">
              </div>
              <div class="form-field half">
                <label for="currentValue" class="field-label">Current Progress</label>
                <input type="number" id="currentValue" name="currentValue" class="field-input"
                       placeholder="0" value="0" min="0">
              </div>
            </div>

            <div class="form-field">
              <label for="unit" class="field-label">Unit (optional)</label>
              <input type="text" id="unit" name="unit" class="field-input"
                     placeholder="e.g., km, lbs, dollars, hours">
            </div>

            <div class="form-field">
              <label for="targetDate" class="field-label">Target Date *</label>
              <input type="date" id="targetDate" name="targetDate" class="field-input" required>
            </div>

            <button type="submit" class="submit-btn">
              <i class="fas fa-target btn-icon"></i>
              Create Goal
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ensure min target date is today
document.addEventListener('DOMContentLoaded', () => {
  const targetDateInput = document.getElementById('targetDate');
  if (targetDateInput) {
    const today = new Date().toISOString().split('T')[0];
    targetDateInput.min = today;
  }
});

// Reminder functionality
function addReminder() {
  const remindersList = document.getElementById('remindersList');
  const reminderId = 'reminder_' + Date.now();
  
  const reminderDiv = document.createElement('div');
  reminderDiv.className = 'reminder-item';
  reminderDiv.innerHTML = `
    <div class="reminder-inputs">
      <input type="time" class="reminder-time" placeholder="--:-- --">
      <button type="button" class="remove-reminder-btn" onclick="removeReminder(this)">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  remindersList.appendChild(reminderDiv);
}

function removeReminder(btn) {
  btn.closest('.reminder-item').remove();
}

// ---- HABIT ----
async function handleCreateHabit() {
  const form = document.getElementById('createHabitForm');
  const errorDiv = document.getElementById('habitErrorMessage');
  errorDiv.style.display = 'none';

  const habitName = document.getElementById('habitName').value.trim();
  const habitCategory = document.getElementById('habitCategory').value;
  const habitCustomCategory = document.getElementById('habitCustomCategory').value.trim();
  const habitFrequency = document.getElementById('habitFrequency').value;
  const habitDifficulty = document.getElementById('habitDifficulty').value;

  // Get all reminder times
  const reminderTimes = [];
  const reminderInputs = document.querySelectorAll('.reminder-time');
  reminderInputs.forEach(input => {
    if (input.value) {
      reminderTimes.push(input.value);
    }
  });

  const payload = {
    name: habitName,
    category: habitCustomCategory || habitCategory,
    frequency: habitFrequency,
    difficulty: habitDifficulty,
    reminderEnabled: reminderTimes.length > 0,
    reminderTimes: reminderTimes
  };

  if (!payload.name) {
    errorDiv.textContent = 'Habit name is required.';
    errorDiv.style.display = 'block';
    return;
  }

  if (!habitCategory && !habitCustomCategory) {
    errorDiv.textContent = 'Please select a category or enter a custom category.';
    errorDiv.style.display = 'block';
    return;
  }

  if (!payload.frequency) {
    errorDiv.textContent = 'Frequency is required.';
    errorDiv.style.display = 'block';
    return;
  }

  const btn = form.querySelector('.submit-btn');
  const oldHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> Creating...';
  btn.disabled = true;

  try {
    const res = await fetch('/api/habits', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload),
    });

    const json = await res.json().catch(() => ({}));
    if (res.ok && json.success) {
      alert('‚úÖ Habit created successfully!');
      form.reset();
      document.getElementById('remindersList').innerHTML = '';
      setTimeout(() => { window.location.href = '/dashboard'; }, 1200);
    } else {
      errorDiv.textContent = (json && (json.error || json.message)) || 'Failed to create habit.';
      errorDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('Habit create error:', err);
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  } finally {
    btn.innerHTML = oldHTML;
    btn.disabled = false;
  }
}

// ---- GOAL ----
async function handleCreateGoal() {
  const form = document.getElementById('createGoalForm');
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.style.display = 'none';

  const goalTitle = document.getElementById('goalTitle').value.trim();
  const description = document.getElementById('description').value.trim();
  const goalType = document.getElementById('goalType').value;
  const targetValue = document.getElementById('targetValue').value;
  const currentValue = document.getElementById('currentValue').value;
  const unit = document.getElementById('unit').value.trim();
  const targetDate = document.getElementById('targetDate').value;

  const payload = {
    title: goalTitle,
    description: description,
    type: goalType,
    targetValue: targetValue ? Number(targetValue) : null,
    currentValue: Number(currentValue || 0),
    unit: unit || null,
    targetDate: targetDate,
  };

  if (!payload.title) {
    errorDiv.textContent = 'Goal title is required';
    errorDiv.style.display = 'block';
    return;
  }
  if (!payload.type) {
    errorDiv.textContent = 'Goal type is required';
    errorDiv.style.display = 'block';
    return;
  }
  if (!payload.targetDate) {
    errorDiv.textContent = 'Target date is required';
    errorDiv.style.display = 'block';
    return;
  }

  const btn = form.querySelector('.submit-btn');
  const oldHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> Creating...';
  btn.disabled = true;

  try {
    const res = await fetch('/create-goal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload),
    });

    const json = await res.json().catch(() => ({}));
    if (res.ok && json.success) {
      alert('üéØ Goal created successfully!');
      form.reset();
      document.getElementById('currentValue').value = '0';
      setTimeout(() => { window.location.href = '/dashboard'; }, 1200);
    } else {
      errorDiv.textContent = (json && (json.error || json.message)) || 'Failed to create goal';
      errorDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('Goal create error:', err);
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  } finally {
    btn.innerHTML = oldHTML;
    btn.disabled = false;
  }
}
</script>
{% endblock %}
