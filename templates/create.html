{% extends "base_dashboard.html" %}

{% block title %}Create - HabitHive{% endblock %}

{% block content %}
<div class="dashboard-main">
  <div class="create-page-content">
    <div class="page-header">
      <h1>Create New Goals & Habits</h1>
      <p>Build positive routines and set meaningful objectives</p>
    </div>

    <div class="create-grid">
      <!-- Left: Create New Habit -->
      <div class="create-card habit-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="title-icon">‚ú®</span>
            Create New Habit
          </h2>
        </div>
        <div class="card-content">
          <!-- NOTE: onsubmit calls the handler and prevents default -->
          <form id="createHabitForm" class="create-form"
                onsubmit="event.preventDefault(); handleCreateHabit();">
            <div id="habitErrorMessage" class="error-message" style="display:none;"></div>

            <div class="form-field">
              <label for="habitName" class="field-label">Habit Name *</label>
              <input type="text" id="habitName" name="habitName" class="field-input"
                     placeholder="e.g., Morning Jog" required>
            </div>

            <div class="form-field">
              <label for="habitPurpose" class="field-label">Purpose *</label>
              <textarea id="habitPurpose" name="habitPurpose" class="field-textarea"
                        placeholder="Why do you want to build this habit?" rows="3" required></textarea>
            </div>

            <div class="form-field">
              <label for="habitFrequency" class="field-label">Frequency *</label>
              <select id="habitFrequency" name="habitFrequency" class="field-select" required>
                <option value="">Select frequency</option>
                <option value="Daily">Daily</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
              </select>
            </div>

            <div class="form-field">
              <label for="habitTiming" class="field-label">Preferred Timing *</label>
              <input type="time" id="habitTiming" name="habitTiming" class="field-input" required>
            </div>

            <div class="form-field">
              <label for="habitReminder" class="field-label">Reminder (Optional)</label>
              <input type="text" id="habitReminder" name="habitReminder" class="field-input"
                     placeholder="e.g., 7:00 AM">
            </div>

            <button type="submit" class="submit-btn">
              <i class="fas fa-plus btn-icon"></i>
              Create Habit
            </button>
          </form>
        </div>
      </div>

      <!-- Right: Create Custom Goal -->
      <div class="create-card goal-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="title-icon">üéØ</span>
            Create Custom Goal
          </h2>
        </div>
        <div class="card-content">
          <form id="createGoalForm" class="create-form"
                onsubmit="event.preventDefault(); handleCreateGoal();">
            <div id="errorMessage" class="error-message" style="display:none;"></div>

            <div class="form-field">
              <label for="goalTitle" class="field-label">Goal Title *</label>
              <input type="text" id="goalTitle" name="goalTitle" class="field-input"
                     placeholder="e.g., Run a Marathon" required>
            </div>

            <div class="form-field">
              <label for="description" class="field-label">Description</label>
              <textarea id="description" name="description" class="field-textarea"
                        placeholder="Describe your goal..." rows="3"></textarea>
            </div>

            <div class="form-field">
              <label for="goalType" class="field-label">Goal Type *</label>
              <select id="goalType" name="goalType" class="field-select" required>
                <option value="">Select a type</option>
                <option value="Fitness">üí™ Fitness</option>
                <option value="Financial">üí∞ Financial</option>
                <option value="Learning">üìö Learning</option>
                <option value="Career">üöÄ Career</option>
                <option value="Personal">üåü Personal</option>
                <option value="Health">üè• Health</option>
                <option value="Relationship">‚ù§Ô∏è Relationship</option>
                <option value="Other">üéØ Other</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-field half">
                <label for="targetValue" class="field-label">Target Value</label>
                <input type="number" id="targetValue" name="targetValue" class="field-input"
                       placeholder="e.g., 42" min="0">
              </div>
              <div class="form-field half">
                <label for="currentValue" class="field-label">Current Progress</label>
                <input type="number" id="currentValue" name="currentValue" class="field-input"
                       placeholder="0" value="0" min="0">
              </div>
            </div>

            <div class="form-field">
              <label for="targetDate" class="field-label">Target Date *</label>
              <input type="date" id="targetDate" name="targetDate" class="field-input" required>
            </div>

            <button type="submit" class="submit-btn">
              <i class="fas fa-target btn-icon"></i>
              Create Goal
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Ensure min target date is today
document.addEventListener('DOMContentLoaded', () => {
  const targetDateInput = document.getElementById('targetDate');
  if (targetDateInput) {
    const today = new Date().toISOString().split('T')[0];
    targetDateInput.min = today;
  }
});

// ---- HABIT ----
async function handleCreateHabit() {
  const form = document.getElementById('createHabitForm');
  const formData = new FormData(form);
  const errorDiv = document.getElementById('habitErrorMessage');
  errorDiv.style.display = 'none';

  const payload = {
    name: (formData.get('habitName') || '').trim(),
    description: (formData.get('habitPurpose') || '').trim(),
    frequency: formData.get('habitFrequency'),
    reminderEnabled: !!formData.get('habitTiming'), 
    reminderTime: formData.get('habitTiming'), 
    userFacingTiming: formData.get('habitTiming'),
  };

  if (!payload.name || !payload.description || !payload.frequency || !payload.userFacingTiming) {
    errorDiv.textContent = 'All fields except Reminder are required.';
    errorDiv.style.display = 'block';
    return;
  }

  const btn = form.querySelector('.submit-btn');
  const oldHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> Creating...';
  btn.disabled = true;

  try {
    const res = await fetch('/api/habits', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin', // send Flask session cookie
      body: JSON.stringify(payload),
    });

    const json = await res.json().catch(() => ({}));
    if (res.ok && json.success) {
      alert('‚úÖ Habit created successfully!');
      form.reset();
    } else {
      errorDiv.textContent = (json && (json.error || json.message)) || 'Failed to create habit.';
      errorDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('Habit create error:', err);
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  } finally {
    btn.innerHTML = oldHTML;
    btn.disabled = false;
  }
}

// ---- GOAL ----
async function handleCreateGoal() {
  const form = document.getElementById('createGoalForm');
  const formData = new FormData(form);
  const errorDiv = document.getElementById('errorMessage');
  errorDiv.style.display = 'none';

  const payload = {
    title: (formData.get('goalTitle') || '').trim(),
    description: (formData.get('description') || '').trim(),
    type: formData.get('goalType'),
    targetValue: formData.get('targetValue') ? Number(formData.get('targetValue')) : null,
    currentValue: Number(formData.get('currentValue') || 0),
    targetDate: formData.get('targetDate'),
  };

  if (!payload.title)  { errorDiv.textContent = 'Goal title is required';  errorDiv.style.display = 'block'; return; }
  if (!payload.type)   { errorDiv.textContent = 'Goal type is required';   errorDiv.style.display = 'block'; return; }
  if (!payload.targetDate) { errorDiv.textContent = 'Target date is required'; errorDiv.style.display = 'block'; return; }

  const btn = form.querySelector('.submit-btn');
  const oldHTML = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin btn-icon"></i> Creating...';
  btn.disabled = true;

  try {
    const res = await fetch('/create-goal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'same-origin',
      body: JSON.stringify(payload),
    });

    const json = await res.json().catch(() => ({}));
    if (res.ok && json.success) {
      // success toast
      alert('üéØ Goal created successfully!');
      form.reset();
      document.getElementById('currentValue').value = '0';
      setTimeout(() => { window.location.href = '/dashboard'; }, 1200);
    } else {
      errorDiv.textContent = (json && (json.error || json.message)) || 'Failed to create goal';
      errorDiv.style.display = 'block';
    }
  } catch (err) {
    console.error('Goal create error:', err);
    errorDiv.textContent = 'Network error. Please try again.';
    errorDiv.style.display = 'block';
  } finally {
    btn.innerHTML = oldHTML;
    btn.disabled = false;
  }
}
</script>
{% endblock %}
