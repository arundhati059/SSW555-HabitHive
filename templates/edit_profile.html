{% extends "base_dashboard.html" %}
{% set p = profile or {} %}

{% block title %}Edit Profile • HabitHive{% endblock %}

{% block content %}
<div class="dashboard-inner">

    <h2 class="page-title mb-4">
        <i class="fas fa-user-edit me-2"></i> Edit Profile
    </h2>

    <div class="card shadow-sm">
        <div class="card-body">

            <!-- ===========================
                 PROFILE EDIT FORM
            ============================ -->
            <form method="POST" enctype="multipart/form-data">

                <!-- Avatar -->
                <div class="text-center mb-4">

                    <img id="avatarPreview"
                         src="{{ p.avatar_url or '/static/img/default-avatar.png' }}"
                         class="rounded-circle"
                         width="130"
                         height="130"
                         style="border:3px solid #eaeaea; object-fit:cover;">

                    <div class="mt-3">
                        <label class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-upload me-1"></i> Change Avatar
                            <input type="file"
                                   name="avatar"
                                   id="avatarInput"
                                   accept="image/*"
                                   style="display:none;">
                        </label>
                    </div>

                    <small class="text-muted d-block mt-2">
                        Recommended: Square • PNG/JPG • Max 2MB
                    </small>
                </div>

                <!-- Email (locked) -->
                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input class="form-control"
                           value="{{ p.email }}"
                           disabled>
                </div>

                <!-- Full Name (locked) -->
                <div class="mb-3">
                    <label class="form-label">Full Name</label>
                    <input class="form-control"
                           value="{{ (p.first_name ~ ' ' ~ p.last_name).strip() }}"
                           disabled>
                </div>

                <!-- Username -->
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input name="display_name"
                           class="form-control"
                           value="{{ p.display_name or p.username }}"
                           placeholder="Enter username..."
                           required>
                </div>

                <button class="btn btn-primary w-100 mt-3">
                    <i class="fas fa-save me-1"></i> Save Changes
                </button>

            </form>

        </div>
    </div>

    <!-- Danger Zone -->
    <div class="card shadow-sm mt-4">
    <div class="card-body">
        <h5 class="mb-2 text-danger">
        <i class="fas fa-exclamation-triangle me-2"></i>Danger Zone
        </h5>
        <p class="text-muted mb-3">
        Deleting your account will permanently remove your profile, habits, goals, and related data. This cannot be undone.
        </p>
        <button type="button"
                class="btn btn-outline-danger"
                onclick="confirmDeleteProfile()">
        <i class="fas fa-user-slash me-1"></i> Delete Account
        </button>
    </div>
    </div>


</div>

<!-- Avatar Preview Script -->
<script>
document.getElementById("avatarInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById("avatarPreview").src = URL.createObjectURL(file);
});
</script>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="module">
    // Import Firebase Auth functions needed for deleting a user
    import {
      deleteUser,                     // Deletes the Firebase authentication user
      reauthenticateWithCredential,   // Forces the user to re-enter credentials before sensitive actions
      EmailAuthProvider               // Allows creating an email/password credential object
    } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';

    async function confirmDeleteProfile() {
      // Ask the user to confirm they really want to delete the account
      const ok = confirm(
        'Are you sure you want to permanently delete your account and all associated data? This cannot be undone.'
      );
      if (!ok) return; // If they hit "Cancel", stop here

      // Get the Firebase Auth instance stored globally on window
      const auth = window.firebaseAuth;
      const user = auth?.currentUser; // Get the currently logged in user

      // If no user is logged in, force re-login
      if (!user) {
        alert('Please log in again and retry account deletion.');
        window.location.href = '/login';
        return;
      }

      // Ask the user to re-enter their password 
      const pwd = prompt('To confirm, please re-enter your password:');
      if (pwd === null) return; // User cancelled prompt

      try {
        // Create a credential object using their email + entered password
        const cred = EmailAuthProvider.credential(user.email, pwd);

        // Reauthenticate user so Firebase allows account deletion
        await reauthenticateWithCredential(user, cred);

        // (1) Call your backend API, from web_app.py, to delete all stored app data (habits, logs, friends list, etc.)
        const res = await fetch('/api/profile/delete', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin', // Sends cookies/session info
        });

        const data = await res.json().catch(() => ({})); // Safe JSON parsing
        if (!res.ok || !data.success) {
          alert('Failed to delete profile data: ' + (data.error || 'Unknown error'));
          return; // Stop if backend cleanup failed
        }

        // (2) Delete the authentication account from Firebase
        await deleteUser(user);

        // (3) Redirect user to login page after deletion
        window.location.href = '/login';

      } catch (err) {
        console.error('Error during full account delete:', err);

        // If Firebase says the login is too old, user must re-login for security reasons
        if (err.code === 'auth/requires-recent-login') {
          alert('For security, please log out and log back in, then try deleting again.');
        } else {
          alert('Error deleting account: ' + (err.message || 'Please try again.'));
        }
      }
    }

    // Expose the function to the global window so HTML onclick="confirmDeleteProfile()" works
    window.confirmDeleteProfile = confirmDeleteProfile;
  </script>
{% endblock %}
